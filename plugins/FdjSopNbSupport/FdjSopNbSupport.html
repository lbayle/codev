<div class="fdjSopNbSupport">
<div class="pluginInitFunction"  style="display: none;">fdjSopNbSupportJsInit</div>
<div class="pluginDestroyFunction"  style="display: none;">fdjSopNbSupportJsDestroy</div>

<div align="left" style="margin-top:1em;">
   <form class="fdjSopNbSupport_form" method="get" action="{$fdjSopNbSupport_ajaxPhpURL}">
      <fieldset>
         <label for="fdjSopNbSupport_startdatepicker">{t}From{/t}:</label>
         <input type="text" class="fdjSopNbSupport_startdatepicker datepicker" name="fdjSopNbSupport_startdate" autocomplete="off" maxlength="10" size="10" title="{t}Start Date{/t}" />
         <label for="fdjSopNbSupport_enddatepicker">{t}To{/t}:</label>
         <input type="text" class="fdjSopNbSupport_enddatepicker datepicker" name="fdjSopNbSupport_enddate" autocomplete="off" maxlength="10" size="10" title="{t}End Date (included){/t}" />
         <input class="fdjSopNbSupport_submit" type="submit" value="{t}Display{/t}" />
         <input type="hidden" name="action" value="getFdjSopNbSupport" />
         <input type="hidden" name="attributesJsonStr" value="" />
         <input type="hidden" name="dashboardId" value="" />
      </fieldset>
   </form>
</div>

<div>
   <div class="fdjSopNbSupportDiv float" align="left"  style="width:95%; margin-top:1em;">
      {include file="`$fdjSopNbSupport_ajaxFile`"}
   </div>

   <div class="floatr" style="margin-top:1em; width: 16px">
      <span class="fdjSopNbSupportHelpDialog_link float pointer">
         <img title="Help" src="images/help_icon.gif"/>
      </span>
      <span class="fdjSopNbSupportConfig_link float pointer">
         <img title="Help" src="images/b_config.png"/>
      </span>
   </div>
   <div class="ui-helper-clearfix"></div>

   <div class="fdjSopNbSupportHelpDialog ui-helper-hidden" title="FDJ SOP Nb Support">
      <p>
         RegEx Support HIA : <span style="margin-left:1em;">{$fdjSopNbSupport_regEx_taskSupportHIA}</span><br>
         RegEx Support Utilisateur: <span style="margin-left:1em;">{$fdjSopNbSupport_regEx_taskSupportUser}</span>
      </p>
   </div>

   <div class="fdjSopNbSupportOptionDialog ui-helper-hidden" title="{t}Options{/t}">
      <table class="invisible fdjSopNbSupport_userSettings_table">
       <thead>
          <tr>
             <th class="left"></th>
             <th class="left">{t}User{/t}</th>
          </tr>
       </thead>
       <tbody>
         {foreach from=$fdjSopNbSupport_userSettings key=id item=i}
          <tr class="fdjSopNbSupport_userSettings_tr">
             <td class="right"><input class="opt_enabled" type="checkbox" {if $i.enabled}checked="checked"{/if}></td>
             <td class="left opt_name" title="{$id}">{$i.name}</td>
             <td class="ui-helper-hidden opt_userid">{$id}</td>
          </tr>
         {/foreach}
       </tbody>
      </table>
   </div>
</div>


<script type="text/javascript">
   // destroy callback: called when the widjet is removed from the dashboard (see inettuts_codevtt.js).
   function fdjSopNbSupportJsDestroy() {
      jQuery(".fdjSopNbSupportHelpDialog").dialog('destroy').remove();
      jQuery(".fdjSopNbSupportOptionDialog").dialog('destroy').remove();
   }

   function fdjSopNbSupport_updateForm() {
      var form = jQuery('.fdjSopNbSupport_form');

      // send attributesJsonStr because the ajax php need to know about 'userSettings'
      var userSettings = {};
      $(".fdjSopNbSupport_userSettings_table .fdjSopNbSupport_userSettings_tr").each(function() {
         var opt_enabled = $(this).find(".opt_enabled").attr('checked') ? 1 : 0;
         var opt_userid  = $(this).find(".opt_userid").html();

         var userData = new Object();
         userData.enabled      = opt_enabled;
         userSettings[opt_userid] = userData;
      });

      // save userSettings in the attributesJsonStr so it can be restored
      var attr = jQuery('.FdjSopNbSupportAttr.attributesJsonStr');
      var attributesJson = jQuery.parseJSON(attr.text());
      attributesJson['userSettings'] = userSettings;
      var attributesJsonStr = JSON.stringify(attributesJson);
      attr.text(attributesJsonStr);
      //console.log('attributesJsonStr=',attributesJsonStr);

      form.find('input[name=attributesJsonStr]').val(attributesJsonStr);
   }

   function fdjSopNbSupport_ajaxUpdate() {

      // send attributesJsonStr because the ajax php need to know about 'userSettings'
      fdjSopNbSupport_updateForm();

      // ajax call to update indicator
      var form = jQuery('.fdjSopNbSupport_form');

      // WARN: Dialogbox is declared in <body>, and there is no parents('.codevttDashboard') !!!
      //var dashboardId = $(this).parents('.codevttDashboard').attr('data-dashboardId');
      var dashboardId = $('.codevttDashboard').attr('data-dashboardId');
      form.find("input[name=dashboardId]").val(dashboardId);

      jQuery.ajax({
         async: false,
         type: form.attr('method'),
         url: form.attr('action'),
         dataType:"json",
         data: form.serialize(),
         success: function(data) {
            jQuery(".fdjSopNbSupportDiv").html(jQuery.trim(data['fdjSopNbSupport_htmlContent']));
            // tabs and datatable libs need to be reload
            jQuery.each(data['fdjSopNbSupport_jsFiles'], function( index, value ) {
               jQuery.ajax({
                     async: false,
                     url: value,
                     dataType: "script"
               });
            });
            saveDashboard();
         },
         error: function(jqXHR, textStatus, errorThrown) {
            if(errorThrown == 'Forbidden') {
               window.location = '{$page}';
            }
         }
      });
   }

   // this function will be run at jQuery(document).ready (see dashboard.html) or
   // when a new widjet is add to the dashboard.
   function fdjSopNbSupportJsInit() {
      console.log('fdjSopNbSupportJsInit');

      jQuery(".fdjSopNbSupportHelpDialog_link").click(function(e) {
         e.preventDefault();
         jQuery(".fdjSopNbSupportHelpDialog").dialog("open");
      });
      jQuery(".fdjSopNbSupportHelpDialog").dialog({
         autoOpen: false,
         resizable: true,
         width: "auto",
         hide: "fade"
      });
      // ------------------------
      // datepicker

      {if $locale != en}
      jQuery.datepicker.setDefaults(jQuery.datepicker.regional['{$locale}']);
      {/if}

      // Set the date
      var startDatePicker = jQuery(".fdjSopNbSupport_startdatepicker").datepicker("setDate" ,"{$fdjSopNbSupport_startDate}");
      var endDatePicker = jQuery(".fdjSopNbSupport_enddatepicker").datepicker("setDate" ,"{$fdjSopNbSupport_endDate}");

      // Add range date
      startDatePicker.datepicker("option","beforeShow",function(input) {
         jQuery(this).datepicker("option","maxDate",endDatePicker.datepicker("getDate"));
      });
      endDatePicker.datepicker("option","beforeShow",function(input) {
         jQuery(this).datepicker("option","minDate",startDatePicker.datepicker("getDate"));
      });
      // ------------------------
      // on reload with new date range
      jQuery('.fdjSopNbSupport_submit').click(function(event) {
         /* stop form from submitting normally */
         event.preventDefault();

         fdjSopNbSupport_ajaxUpdate();

      });

      jQuery(".fdjSopNbSupportConfig_link").click(function(e) {
         e.preventDefault();
         jQuery(".fdjSopNbSupportOptionDialog").dialog("open");
      });
      jQuery(".fdjSopNbSupportOptionDialog").dialog({
         autoOpen: false,
         height: 'auto',
         width: "auto",
         //hide: "fade",
         modal: true,
         buttons: {
            Ok: function() {
               // stop form from submitting normally
               //event.preventDefault();

               fdjSopNbSupport_ajaxUpdate();

               jQuery(this).dialog( "close" );
            },
            Cancel: function() {
               // TODO restore previous values
               jQuery(this).dialog( "close" );
            }
         }
      });


   };
</script>
</div>
