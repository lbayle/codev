<div class="fdjSopUsines">
<div class="pluginInitFunction"  style="display: none;">fdjSopUsinesJsInit</div>
<div class="pluginDestroyFunction"  style="display: none;">fdjSopUsinesJsDestroy</div>

   <div align="left" style="margin-top:1em;">
      <form id="fdjSopUsines_dateRange_form" method="get" action="{$fdjSopUsines_ajaxPhpURL}">
         <fieldset>
            <label for="fdjSopUsines_startdatepicker">{t}From{/t}:</label>
            <input type="text" class="fdjSopUsines_startdatepicker datepicker" name="fdjSopUsines_startdate" autocomplete="off" maxlength="10" size="10" title="{t}Start Date{/t}" />
            <label for="fdjSopUsines_enddatepicker">{t}To{/t}:</label>
            <input type="text" class="fdjSopUsines_enddatepicker datepicker" name="fdjSopUsines_enddate" autocomplete="off" maxlength="10" size="10" title="{t}End Date (included){/t}" />
            <input class="fdjSopUsines_submit" type="submit" value="{t}Display{/t}" />
            <input type="hidden" name="action" value="getFdjSopUsines" />
            <input type="hidden" name="dashboardId" value="" />
         </fieldset>
      </form>
   </div>

<div>
   <div class="fdjSopUsinesDiv" align="left" style="margin-top: 1em;">
      {include file="`$fdjSopUsines_ajaxFile`"}
   </div>

   <div class="floatr" style="margin-top:1em; width: 16px">
      <span class="fdjSopUsinesHelpDialog_link float pointer">
         <img title="Help" src="images/help_icon.gif"/>
      </span>
      <span class="float pointer">
         <img title="Export to CSV" src="images/b_export_xls.gif" onclick="$('.fdjSopUsinesCatPerJobs').table2CSV({literal}{{/literal}filename : 'fdjSopUsinesCatPerJobs.csv'{literal}}{/literal})">
      </span>
   </div>
   <div class="fdjSopUsinesHelpDialog ui-helper-hidden" title="== FDJ == SOP - ConsommÃ© par usine">
      <p>
         <strong>{t}Description{/t}:</strong><br>
      </p>
   </div>

   <div class="ui-helper-clearfix"></div>
</div>

<script type="text/javascript">
   // destroy callback: called when the widjet is removed from the dashboard (see inettuts_codevtt.js).
   function fdjSopUsinesJsDestroy() {
      jQuery(".fdjSopUsinesHelpDialog").dialog('destroy').remove();
   }

   // this function will be run at jQuery(document).ready (see dashboard.html) or
   // when a new widjet is add to the dashboard.
   function fdjSopUsinesJsInit() {
      console.log('fdjSopUsinesJsInit');

      // ------------------------
      // datepicker
      {if $locale != en}
      jQuery.datepicker.setDefaults(jQuery.datepicker.regional['{$locale}']);
      {/if}
      // Set the date
      var startDatePicker = jQuery(".fdjSopUsines_startdatepicker").datepicker("setDate" ,"{$fdjSopUsines_startDate}");
      var endDatePicker = jQuery(".fdjSopUsines_enddatepicker").datepicker("setDate" ,"{$fdjSopUsines_endDate}");

      // Add range date
      startDatePicker.datepicker("option","beforeShow",function(input) {
         jQuery(this).datepicker("option","maxDate",endDatePicker.datepicker("getDate"));
      });
      endDatePicker.datepicker("option","beforeShow",function(input) {
         jQuery(this).datepicker("option","minDate",startDatePicker.datepicker("getDate"));
      });

      // ------------------------
      // on reload with new date range
      jQuery('.fdjSopUsines_submit').click(function(event) {
         /* stop form from submitting normally */
         event.preventDefault();

         var form = jQuery('#fdjSopUsines_dateRange_form');

         var dashboardId = $(this).parents('.codevttDashboard').attr('data-dashboardId');
         form.find("input[name=dashboardId]").val(dashboardId);

         var url = form.attr('action');
         var type = form.attr('method');
         jQuery.ajax({
            async: false,
            type: type,
            url: url,
            dataType:"json",
            data: form.serialize(),
            success: function(data) {
               jQuery(".fdjSopUsinesDiv").html(jQuery.trim(data['fdjSopUsines_htmlTable']));
               var chart = jQuery('.fdjSopUsinesChart');
               if (data['fdjSopUsines_jqplotData']) {
                  chart.show();
                  var chartoptions = chart.data('plotoptions');
                  chartoptions.seriesColors = data['fdjSopUsines_colors'];
                  updateChart(chart, data['fdjSopUsines_jqplotData']);
               } else {
                  chart.empty();
                  chart.hide();
               }
            },
            error: function(jqXHR, textStatus, errorThrown) {
               if(errorThrown == 'Forbidden') {
                  window.location = '{$page}';
               }
            }
         });
      });

      // ------------------------
      jQuery(".fdjSopUsinesHelpDialog_link").click(function(e) {
         e.preventDefault();
         jQuery(".fdjSopUsinesHelpDialog").dialog("open");
      });
      jQuery(".fdjSopUsinesHelpDialog").dialog({
         autoOpen: false,
         resizable: true,
         width: "auto",
         hide: "fade"
      });
   };
</script>
</div>
