<script type="text/javascript">

    function updateRemaining(dialogBoxTitle, bugid, remaining, description, userid, nextForm ){
        jQuery( "#desc_summary" ).text(description);
        
        jQuery( "#formUpdateRemaining * #remaining" ).val(remaining);
        jQuery( "#formUpdateRemaining input[name=bugid]" ).val(bugid);
        jQuery( "#formUpdateRemaining input[name=userid]" ).val(userid);
        jQuery( "#formUpdateRemaining input[name=nextForm]" ).val(nextForm);

        jQuery( "#update_remaining_dialog_form" ).dialog('option', 'title', dialogBoxTitle);
        jQuery( "#update_remaining_dialog_form" ).dialog( "open" );
    }

    // ------ JQUERY ------
    jQuery(document).ready(function(){
        var  remaining = $( "#remaining" ),
        allFields = $( [] ).add( remaining ),
        tips = $( "#validateTips" ).hide();

        function updateTips( t ) {
            tips.show();
            tips.text( t )
                .addClass( "ui-state-highlight" );
            setTimeout(function() {
                tips.removeClass( "ui-state-highlight", 1500 );
            }, 500 );
        }

        function checkRegexp( o, regexp, n ) {
            if ( !( regexp.test( o.val() ) ) ) {
                o.addClass( "ui-state-error" );
                updateTips( n );
                return false;
            } else {
                return true;
            }
        }

        jQuery( "#update_remaining_dialog_form" ).dialog({
            autoOpen: false,
            height: 250,
            width: 500,
            modal: true,
            open: function() {
                // Select input field contents
                $( "#remaining" ).select();
            },
            buttons: {
                "Update": function() {
                    var bValid = true;
                    allFields.removeClass( "ui-state-error" );
                    bValid = bValid && checkRegexp( remaining, /^[0-9]+(\.[0-9]5?)?$/i, "format:  '1',  '0.3'  or  '2.55'" );

                    if ( bValid ) {
                        // TODO use AJAX to call php func and update remaining on bugid
                        jQuery('#formUpdateRemaining').submit();
                    }
                },
                Cancel: function() {
                    jQuery( this ).dialog( "close" );
                }
            },
            close: function() {
                tips.empty();
                tips.hide();
                allFields.val( "" ).removeClass( "ui-state-error" );
            }
        });

    });
</script>

<div id="update_remaining_dialog_form" title="Task XXX - Update Remaining" style="display: none">
    <p id="desc_summary"></p>
    <form id="formUpdateRemaining" name="formUpdateRemaining" method="post" action="{$page}" >
        <fieldset style="padding:0; border:0;">
            <label for="remaining">Remaining: </label><input type="text" id="remaining" name="remaining" size="3" class="text" value="noValue" />
            <input type="hidden" name="bugid" value="0" />
            <input type="hidden" name="userid" value="0" />
            <input type="hidden" name="nextForm" value="unspecifiedForm" />
            <input type="hidden" name="action" value="updateRemainingAction" />
       </fieldset>
    </form>
    <p id="validateTips" style="display: none; border: 1px solid transparent; padding: 0.3em;"></p>
</div>

{if $ie}
<div style="color:red;margin-top:2em;">
    {t}IE may not correctly display this website{/t},<br/>
    {t}please consider using a standard complient web-browser{/t}.<br/>
</div>
{/if}

<!-- Main content -->
<div id="homepage_list" class="left" style="margin-top:2em;">
    <ul>
        <li><a href="{$mantisURL}">Mantis</a></li>
    </ul>
    <ul>
        <!-- Saisie des CRA -->
        <li><a href="timetracking/time_tracking.php">{t}Time Tracking{/t}</a></li>
        <!-- Affichage des congé&eacute;s -->
        <li><a href="timetracking/holidays_report.php">{t}Holidays{/t}</a></li>
    </ul>
    <ul>
        <!-- Affichage du planning -->
        <li><a href="reports/planning_report.php">{t}Planning{/t}</a></li>
        <!-- Info fiche -->
        <li><a href="reports/issue_info.php">{t}Task information{/t}</a></li>
        <!-- Activit&eacute; hebdomadaire -->
        <li><a href="timetracking/team_activity_report.php">{t}Weekly activity{/t}</a></li>
        <!-- Indicateurs de production -->
        <!-- <li><a href="reports/productivity_report.php">{t}Productivity Reports{/t}</a></li> -->
    </ul>
</div>

{if $driftedTasks}
<!-- Consistency errors -->
<div style="margin-top:2em;">
    <hr style="margin-bottom:2em; "/>
    <table>
        <caption>{t}Tasks in drift{/t}</caption>
        <tr>
            <th>{t}ID{/t}</th>
            <th>{t}Project{/t}</th>
            <!-- <th title="Derive par rapport a l estimation preliminaire">{t}Derive PrelEE{/t}</th> -->
            <th title="Derive par rapport au BI+BS">{t}Drift{/t}</th>
            <th>{t}RAF{/t}</th>
            <th>{t}Summary{/t}</th>
        </tr>
        {foreach from=$driftedTasks key=id item=i}
        <tr>
            <td>{$i.issueInfoURL}</td>
            <td>{$i.projectName}</td>
            <td {if $i.driftEE > 0}style="background-color: #fcbdbd;"{elseif $i.driftEE < 0}style="background-color: #61ed66;"{/if}>{$i.driftEE}</td>
            <td><a title="{t}update Remaining{/t}" href="javascript: updateRemaining('Task {$i.formatedTitle} - Update Remaining', '{$i.bugId}', '{$i.remaining}', '{$i.formatedSummary}', '', '')">{$i.remaining}</a></td>
            <td>{$summary}</td>
        </tr>
        {/foreach}
    </table>
</div>
{/if}

{if $consistencyErrors}
<!-- Consistency errors -->
<div style="margin-top:2em;">
    <hr style="margin-bottom:2em;" />
    <div>
        {foreach from=$consistencyErrors key=id item=i}
        {t}ERROR on task {/t}{$i.mantisIssueURL} : &nbsp;&nbsp;<span style="color:red">{$i.date}&nbsp;&nbsp;{$i.status}&nbsp;&nbsp;{$i.desc}</span><br/>
        {/foreach}
    </div>
</div>
{/if}
