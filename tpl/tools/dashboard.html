<div id="inettutsDashboard">
<!--
This file is associated to
- classes/Dashboard.class.php
- include/dashboard_ajax.php

TODO
- replace id by class (id="head", id="columns", id="column1", ...)
- dialogbox to add dashboardPluginCandidates
- form to save dashboard & plugins settings (call include/dashboard_ajax.php)

 when adding a plugin, a dialogbox should raise to set the plugin attributes.
 the content of this dialog is furnished by the plugin and loaded by ajax
-->
   


   <link href="lib/inettuts/inettuts_codevtt.css" rel="stylesheet" type="text/css" />

    <div id="head">
        <h2>{$dashboardTitle}</h2>
         <button  title="{t}Add an indicator to the dashboard{/t}" href="include/dashboard_ajax.php" onclick="addDashboardPlugin();return false;">
            <img align="absmiddle" border="0" src="images/b_add.png" alt="Add icon">
            {t}Add{/t}
         </button>
         <button  title="{t}Save dashboard settings{/t}">
            <img align="absmiddle" border="0" src="images/b_save.png" alt="Add icon">
            {t}Save{/t}
         </button>
         <div id="dialogAddDashboardPlugin" title="{t}Add Indicator{/t}" class="ui-helper-hidden">
            <div  style="width: 500px; margin-top:1em;"></div>
            <form id="formAddDashboardPlugin" name="formAddDashboardPlugin" method="post" action="{$page}" >
               <fieldset>
                  <strong>{t}Indicator{/t}:</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                  <select class="cbPluginCandidates" name="pluginClassName">
                     <option value="0"></option>
                     {foreach from=$dashboardPluginCandidates key=id item=i}
                     <option value="{$i.pluginClassName}">{$i.title}</option>
                     {/foreach}
                  </select>
                  <div class="pluginConfig" style="display: none;">
                  <div style="margin-top:1em;">
                     <strong>{t}Description{/t}:</strong><br>
                     <hr>
                     <div class="pluginDescription"></div>
                  </div>
                  <div style="margin-top:2em;">
                     <strong>{t}Attributes{/t}:</strong><br>
                     <hr>
                     <div class="pluginAttributes">
                     </div>
                  </div>
                  </div>
                  <input type="hidden" name="action" value="addDashboardPlugin" />
                  <input type="hidden" name="pluginAttributesJsonStr" value="0" />
               </fieldset>
            </form>
         </div>
      </div>

    <div id="columns">

        <ul id="column1" class="column">
           {foreach from=$dashboardWidgets key=id item=i}
            <li class="widget {$i.color}" id="{$i.id}">
               <form><input type="hidden" name="attributesJsonStr" value='{$i.attributesJsonStr}'/></form>
                <div class="widget-head">
                    <h3>{$i.title}</h3>
                </div>
                <div class="widget-content">
                   {$i.content}
                </div>
            </li>
           {/foreach}

            <li class="widget color-yellow">
                <form><input type="hidden" name="attributesJsonStr" value='{literal}{"pluginClassName":"FakeIndictor2","dateRange":"defaultRange","isGraphOnly":0}{/literal}'/></form>
                <div class="widget-head">
                    <h3>Extra Info</h3>
                </div>
                <div class="widget-content">
                    <p>Try clicking the 'X' in the top right of this widget... Just watch how cool the animaton is! :D</p>
                    <ul>
                        <li>Since this is just a demo your settings will NOT be saved anywhere when you leave the page.</li>
                        <li>This demo has been tested successfully on a Windows XP PC in the following browsers: Firefox 2, Firefox 3, Chrome, Safari 3, Opera 9.5, IE6, IE7</li>
                    </ul>
                </div>
            </li>
            <li class="widget color-green">
                <form><input type="hidden" name="attributesJsonStr" value='{literal}{"pluginClassName":"FakeIndictor3","dateRange":"defaultRange","isGraphOnly":0}{/literal}'/></form>
                <div class="widget-head">
                    <h3>Some Random Title</h3>
                </div>
                <div class="widget-content">
                    <ul>
                        <li>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aliquam magna sem, fringilla in, commodo a, rutrum ut, massa. Donec id nibh eu dui auctor tempor. Morbi laoreet eleifend dolor. Suspendisse pede odio, accumsan vitae, auctor non, suscipit at, ipsum. Cras varius sapien vel lectus.</li>
                    </ul>
                </div>
            </li>
        </ul>

    </div>

    <script type="text/javascript" src="lib/inettuts/inettuts_codevtt.js"></script>

    <script type="text/javascript">
      function addDashboardPlugin(){
         jQuery("#dialogAddDashboardPlugin").dialog("open");
      }

      jQuery(document).ready(function() {
         
         jQuery("#dialogAddDashboardPlugin").dialog({
            autoOpen: false,
            resizable: true,
            width: "auto",
            modal: true,
            buttons: {
               "Add": function() {

                  // on définit le sélecteur permettant de différencier:
                  // - les champs type "options du plugin" (ceux qui sont affichés)
                  // - les champs types "est envoyé en AJAX puis enregistré sur le serveur" (qui sont masqués),
                  var ajaxFieldSelector = '[type=hidden]';

                  var form = $('#formAddDashboardPlugin');

                  // visible fields (input/select/textarea) are raw data to be parsed
                  var $pluginElements = form.find(':input:not('+ajaxFieldSelector+')');

                  // hidden fields: processed data returned by ajax
                  var formElements = form.find(':input'+ajaxFieldSelector);

                  // on transforme la liste des options en tableau associatif JS
                  // (qui est un **objet JSON** en fait, puisque JSON = JavaScript Object Notation ;)
                  var pluginAttributesArray = $pluginElements.serializeArray();

                  // on récupère la liste des checkbox non cochées
                  // on effectue manuellement un "serializeArray" dessus
                  // on rajoute cette liste "manuelle" à la liste retournée par jQuery
                  var uncheckedElements = $pluginElements.filter('input[type=checkbox]:not(:checked)');
                  var uncheckedElementsArray = uncheckedElements.map(function(i, checkbox){ return { name:checkbox.name, value:0 }; }).get();
                  pluginAttributesArray = pluginAttributesArray.concat(uncheckedElementsArray);

                  // on transforme cet **objet JSON** en **chaine JSON**
                  var pluginOptionsJSONString = JSON.stringify(pluginAttributesArray);

                  // hidden fields: processed data returned returned by ajax
                  var formElements = form.find(':input'+ajaxFieldSelector);
                  formElements.filter('[name=pluginAttributesJsonStr]').val(pluginOptionsJSONString);
                  var dataToSend = formElements.serializeArray();
                  console.log('dataToSend = ', dataToSend.length, dataToSend);

                  $.ajax({
                     url: 'include/dashboard_ajax.php',
                     type: form.attr('method'),
                     dataType:"json",
                     data: dataToSend,
                     success: function(data) {
                        //console.log(data['widget']);
                        var widget = data['widget'];

                        // Add new Widget to the dashboard
                        var ulObj = jQuery("#column1");
                        var liObj = jQuery('<li></li>').addClass("widget").addClass(widget['color']);
                        var divHeadObj = jQuery('<div></div>').addClass("widget-head").append(jQuery('<h3></h3>').html(widget['title']));
                        var divContentObj = jQuery('<div></div>').addClass("widget-content").html(widget['content']);
                        
                        //var inputObj = jQuery('<input type="hidden" name="attributesJsonStr" value=\''+widget['attributesJsonStr']+'\'/>');
                        var inputObj = jQuery('<input type="hidden" name="attributesJsonStr"/>').val(widget['attributesJsonStr']);
                        var formObj = jQuery('<form></form>').append(inputObj);
                        liObj.append(formObj).append(divHeadObj).append(divContentObj);
                        ulObj.append(liObj);

                        console.log(liObj);
                        jQuery("#dialogAddDashboardPlugin").dialog("close");

                     },
                     error:  function() {
                        alert("AddDashboardPlugin ERROR!");
                        jQuery("#dialogAddDashboardPlugin").dialog("close");
                     }
                  });

               },
               Cancel: function() {
                  jQuery(this).dialog("close");
               }
            }
         });

         jQuery(".cbPluginCandidates").change(function() {
            if ('0' !== this.value) {
               jQuery.ajax({
                  type: "POST",
                    url: 'include/dashboard_ajax.php',
                    dataType:"json",
                    data: { pluginClassName: this.value,
                            action: "getPluginConfigInfo"
                    },
                    success: function(data) {
                       jQuery('.pluginDescription').html(data['description']);
                       jQuery(".pluginAttributes").html(jQuery.trim(data['attributesHtml']));
                       jQuery(".pluginConfig").show();
                    },
                    error:  function() {
                       alert("getPluginConfigInfo ERROR!");
                    }
               });
            } else {
               jQuery('.pluginDescription').html('');
               jQuery(".pluginAttributes").html('');
               jQuery(".pluginConfig").hide();

            }
         });

      });
    </script>

</div>
