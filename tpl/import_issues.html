
<div id="content" class="center">


   {if !$filename}

   <!-- FILE SELECTION -->
   <div style="margin-top:3em;">
      <h2 class="center">{t}Select CSV file{/t}</h2>

      <form method="post" action="{$page}" enctype="multipart/form-data"  id="formUploadFile" name="formUploadFile" >
         <fieldset>
            {include file="form/teamProjectSelector.html"}
            <input type="file" name="uploaded_csv">
            <input type="submit" value="{t}Preview import{/t}">

            <input type="hidden" name="action" value="uploadFile" />
            <input type="hidden" name="MAX_FILE_SIZE" value="2097152">
         </fieldset>

      </form>
   </div>
   {/if}

   {if $errorMsg}
      <div style="margin-top:2em;">
         <span style='color:red'>ERROR: {$errorMsg}</span>
      </div>
   {/if}

   {if $newIssues}

      <script type="text/javascript">

      //------ DATATABLE JQUERY --------
      $(document).ready(function() {

         var oTable = $('#issues_table').dataTable( {
            "bProcessing": false,
            "sScrollY": "700px",
            "bPaginate": false,
            "bScrollCollapse": true,
            "bFilter": true,
            "bSort": true,
            "bInfo": false,
            "bAutoWidth": false,
            "fnDrawCallback": function () {

                  $('.summary').editable( function(value, settings) { return(value); }, {
                     data   : function(value, settings) { return value; },
                     type   : 'textarea',
                     submit : 'OK',
                     placeholder : '',

                     "callback": function( sValue, y ) {
                        /* Redraw the table */
                        var aPos = oTable.fnGetPosition( this );
                        oTable.fnUpdate( sValue, aPos[0], aPos[1] );
                        oTable.fnDraw();
                     },
                     "height": "14px"
                  } );
                  $('.mgrEffortEstim').editable( function(value, settings) { return(value); }, {
                     data   : function(value, settings) { return value; },
                     type   : 'textarea',
                     submit : 'OK',
                     placeholder : '',

                     "callback": function( sValue, y ) {
                        /* Redraw the table */
                        var aPos = oTable.fnGetPosition( this );
                        oTable.fnUpdate( sValue, aPos[0], aPos[1] );
                        oTable.fnDraw();
                     },
                     "height": "14px"
                  } );
                  $('.effortEstim').editable( function(value, settings) { return(value); }, {
                     data   : function(value, settings) { return value; },
                     type   : 'textarea',
                     submit : 'OK',
                     placeholder : '',

                     "callback": function( sValue, y ) {
                        /* Redraw the table */
                        var aPos = oTable.fnGetPosition( this );
                        oTable.fnUpdate( sValue, aPos[0], aPos[1] );
                        oTable.fnDraw();
                     },
                     "height": "14px"
                  } );
                  $('.command').editable( function(value, settings) {
                                             // save id
                                             // you cannot set data if column is hidden !
                                             oTable.fnSetColumnVis( 9, true );
                                             jQuery(this).parent().find('td.commandid').text(value);
                                             oTable.fnSetColumnVis( 9, false );

                                             // set displayed value
                                             var items = JSON.parse(settings.data);
                                             return(items[value]); }, {
                     data        : '{$jed_commandList}',
                     type        : 'select',
                     submit      : 'OK',
                     placeholder : '',

                     "callback": function( sValue, y ) {
                        /* Redraw the table */
                        var aPos = oTable.fnGetPosition( this );
                        oTable.fnUpdate( sValue, aPos[0], aPos[1] );
                        oTable.fnDraw();
                     },
                     "height": "14px"
                  } );
                  $('.category').editable( function(value, settings) {
                                             oTable.fnSetColumnVis( 10, true );
                                             jQuery(this).parent().find('td.categoryid').text(value);
                                             oTable.fnSetColumnVis( 10, false );
                                             var items = JSON.parse(settings.data);
                                             return(items[value]); }, {
                     data        : '{$jed_categoryList}',
                     type        : 'select',
                     submit      : 'OK',
                     placeholder : '',

                     "callback": function( sValue, y ) {
                        /* Redraw the table */
                        var aPos = oTable.fnGetPosition( this );
                        oTable.fnUpdate( sValue, aPos[0], aPos[1] );
                        oTable.fnDraw();
                     },
                     "height": "14px"
                  } );
                  $('.targetVersion').editable( function(value, settings) {
                                             oTable.fnSetColumnVis( 11, true );
                                             jQuery(this).parent().find('td.targetversionid').text(value);
                                             oTable.fnSetColumnVis( 11, false );
                                             var items = JSON.parse(settings.data);
                                             return(items[value]); }, {
                     data        : '{$jed_targetVersionList}',
                     type        : 'select',
                     submit      : 'OK',
                     placeholder : '',

                     "callback": function( sValue, y ) {
                        /* Redraw the table */
                        var aPos = oTable.fnGetPosition( this );
                        oTable.fnUpdate( sValue, aPos[0], aPos[1] );
                        oTable.fnDraw();
                     },
                     "height": "14px"
                  } );
                  $('.userName').editable( function(value, settings) {
                                             oTable.fnSetColumnVis( 12, true );
                                             jQuery(this).parent().find('td.userid').text(value);
                                             oTable.fnSetColumnVis( 12, false );
                                             var items = JSON.parse(settings.data);
                                             return(items[value]); }, {
                     data        : '{$jed_userList}',
                     type        : 'select',
                     submit      : 'OK',
                     placeholder : '',

                     "callback": function( sValue, y ) {
                        /* Redraw the table */
                        var aPos = oTable.fnGetPosition( this );
                        oTable.fnUpdate( sValue, aPos[0], aPos[1] );
                        oTable.fnDraw();
                     },
                     "height": "14px"
                  } );
            }
         } );

         // hide columns: commandid, categoryid, targetversionid, userid, description
         oTable.fnSetColumnVis( 9, false );
         oTable.fnSetColumnVis( 10, false );
         oTable.fnSetColumnVis( 11, false );
         oTable.fnSetColumnVis( 12, false );
         oTable.fnSetColumnVis( 13, false );
      });

      </script>



      <!-- GLOBAL VALUES BUTTONS  -->
      <div  class="left" style="margin-top:6em;">

         <script type="text/javascript">
            jQuery(document).ready(function() {

               var oTable = $('#issues_table').dataTable();

               jQuery("#btSetAllCommands").click(function(event) {
                  // you cannot set data if column is hidden !
                  oTable.fnSetColumnVis( 9, true );
                  $('#issues_table tbody tr').each( function () {
                     var iPos = oTable.fnGetPosition( this );
                     if (iPos!=null) {
                        var value = jQuery('#globalCommandid option:selected').text();
                        var key = jQuery('#globalCommandid option:selected').val();

                        jQuery(this).find('td.command').text(value);
                        jQuery(this).find('td.commandid').text(key);
                     }
                  });
                  // hide column: categoryid
                  oTable.fnSetColumnVis( 9, false );
               });

               jQuery("#btSetAllCategories").click(function(event) {
                  // you cannot set data if column is hidden !
                  oTable.fnSetColumnVis( 10, true );
                  $('#issues_table tbody tr').each( function () {
                     var iPos = oTable.fnGetPosition( this );
                     if (iPos!=null) {
                        var value = jQuery('#globalCategoryid option:selected').text();
                        var key = jQuery('#globalCategoryid option:selected').val();

                        jQuery(this).find('td.category').text(value);
                        jQuery(this).find('td.categoryid').text(key);
                     }
                  });
                  // hide column: categoryid
                  oTable.fnSetColumnVis( 10, false );
               });

               jQuery("#btSetAllTargetVersions").click(function(event) {

                  // you cannot set data if column is hidden !
                  oTable.fnSetColumnVis( 11, true );
                  $('#issues_table tbody tr').each( function () {
                     var iPos = oTable.fnGetPosition( this );
                     if (iPos!=null) {
                        var value = jQuery('#globalTargetversionid option:selected').text();
                        var key = jQuery('#globalTargetversionid option:selected').val();

                        jQuery(this).find('td.targetVersion').text(value);
                        jQuery(this).find('td.targetversionid').text(key);
                     }
                  });
                  // hide column: categoryid
                  oTable.fnSetColumnVis( 11, false );
               });

               jQuery("#btSetAllUsers").click(function(event) {

                  // you cannot set data if column is hidden !
                  oTable.fnSetColumnVis( 12, true );
                  $('#issues_table tbody tr').each( function () {
                     var iPos = oTable.fnGetPosition( this );
                     if (iPos!=null) {
                        var value = jQuery('#globalUserid option:selected').text();
                        var key = jQuery('#globalUserid option:selected').val();

                        jQuery(this).find('td.userName').text(value);
                        jQuery(this).find('td.userid').text(key);
                     }
                  });
                  // hide column: categoryid
                  oTable.fnSetColumnVis( 12, false );
               });

            });
         </script>

         <table class='invisible'>
            <tr>
               <td>{t}Team{/t}</td>
               <td>:</td>
               <td>{$teamName}</td>
               <td></td>
            </tr>
            <tr>
               <td>{t}Project{/t}</td>
               <td>:</td>
               <td>{$projectName}</td>
               <td></td>
            </tr>
            <tr>
               <td>{t}File{/t}</td>
               <td>:</td>
               <td>{$filename}</td>
               <td></td>
            </tr>
            <tr>
               <td>{t}Command{/t}</td>
               <td>:</td>
               <td>
                  <select id="globalCommandid" name="globalCommandid">
                  {foreach from=$commandList key=id item=i}
                     <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                  {/foreach}
                  </select>
               </td>
               <td>
                  <button type='button' name="btSetAllCommands" id="btSetAllCommands">{t}Set All{/t}</button>
               </td>
            </tr>
            <tr>
               <td>{t}Category{/t}</td>
               <td>:</td>
               <td>
                  <select id="globalCategoryid" name="globalCategoryid">
                  {foreach from=$categoryList key=id item=i}
                     <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                  {/foreach}
                  </select>
               </td>
               <td>
                  <button type='button' name="btSetAllCategories" id="btSetAllCategories">{t}Set All{/t}</button>
               </td>
            </tr>
            <tr>
               <td>{t}TargetVersion{/t}</td>
               <td>:</td>
               <td>
                  <select id="globalTargetversionid" name="globalTargetversionid">
                  {foreach from=$targetversionList key=id item=i}
                     <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                  {/foreach}
                  </select>
               </td>
               <td>
                  <button type='button' name="btSetAllTargetVersions" id="btSetAllTargetVersions">{t}Set All{/t}</button>
               </td>
            </tr>
            <tr>
               <td>{t}User{/t}</td>
               <td>:</td>
               <td>
                  <select id="globalUserid" name="globalUserid">
                  {foreach from=$userList key=id item=i}
                     <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                  {/foreach}
                  </select>
               </td>
               <td>
                  <button type='button' name="btSetAllUsers" id="btSetAllUsers">{t}Set All{/t}</button>
               </td>
            </tr>
         </table>

      </div>

      <!-- DISPLAY ISSUES TABLE -->
      <div style="margin-top:2em;">

         {if $newIssues}
         <table id="issues_table" class="display">
            <caption>{t}Mantis issues to create:{/t}</caption>
            <thead>
            <tr>
                  <th>Id</th>
                  <th>ExtRef</th>
                  <th>Summary</th>
                  <th>Charge Mgr</th>
                  <th>Charge</th>
                  <th>Command</th>
                  <th>Category</th>
                  <th>TargetVersion</th>
                  <th>User</th>
                  <th>commandid</th>
                  <th>categoryid</th>
                  <th>targetversionid</th>
                  <th>userid</th>
                  <th>description</th>
            </tr>
            </thead>
            <tbody>
            {foreach from=$newIssues key=id item=i}
            <tr>
                  <td class="lineNum" align='right'>{$i.lineNum}</td>
                  <td class="extRef" align='left'>{$i.extRef}</td>
                  <td class="summary" align='left' {$i.summary_attr} >{$i.summary}</td>
                  <td class="mgrEffortEstim">{$i.mgrEffortEstim}</td>
                  <td class="effortEstim">{$i.effortEstim}</td>
                  <td class="command" align='left'>{$i.command}</td>
                  <td class="category" align='left'>{$i.category}</td>
                  <td class="targetVersion" align='left'>{$i.targetVersion}</td>
                  <td class="userName" align='left'>{$i.userName}</td>
                  <td class="commandid"></td>
                  <td class="categoryid"></td>
                  <td class="targetversionid"></td>
                  <td class="userid"></td>
                  <td class="description">{$i.description}</td>

            </tr>
            {/foreach}
            </tbody>
         </table>
         {/if}
      </div>

      <!-- IMPORT BUTTON  -->
      <div  class="left" style="margin-top:2em;">

         <script type="text/javascript">
            jQuery(document).ready(function() {

               jQuery("#btImportIssues").click(function(event) {

                  jQuery("body").css('cursor','wait');

                  var oTable = $('#issues_table').dataTable();

                  // you cannot get data if column is hidden !
                  oTable.fnSetColumnVis( 9, true );
                  oTable.fnSetColumnVis( 10, true );
                  oTable.fnSetColumnVis( 11, true );
                  oTable.fnSetColumnVis( 12, true );
                  oTable.fnSetColumnVis( 13, true );

                  $('#issues_table tbody tr').each( function () {
                     var iPos = oTable.fnGetPosition( this );
                     if (iPos!=null) {

                        var extRef = jQuery(this).find('td.extRef').text();
                        var summary = jQuery(this).find('td.summary').text();
                        var mgrEffortEstim = jQuery(this).find('td.mgrEffortEstim').text();
                        var effortEstim = jQuery(this).find('td.effortEstim').text();
                        var commandid = jQuery(this).find('td.commandid').text();
                        var categoryid = jQuery(this).find('td.categoryid').text();
                        var targetversionid = jQuery(this).find('td.targetversionid').text();
                        var userid = jQuery(this).find('td.userid').text();
                        var description = jQuery(this).find('td.description').text();

                        jQuery.ajax({
                           type: "POST",
                           url:  "import/import_row_ajax.php",
                           data: "action=importRow"+
                                 "&projectid={$projectid}"+
                                 "&extRef="+extRef+
                                 "&summary="+summary+
                                 "&mgrEffortEstim="+mgrEffortEstim+
                                 "&effortEstim="+effortEstim+
                                 "&commandid="+commandid+
                                 "&categoryid="+categoryid+
                                 "&targetversionid="+targetversionid+
                                 "&userid="+userid+
                                 "&description="+description,
                           success: function(data) {
                              //alert("row "+data+" imported.");

                              // TODO update datatable
                              //jQuery(this).find('td.lineNum').text(data);
                              //var pos = oTable.fnGetPosition( jQuery(this).find('td.lineNum').get(0) );
                              //oTable.fnUpdate( data, pos[0], pos[1] );
                              //oTable.fnDraw();

                           },
                           error: function(jqXHR, textStatus, errorThrown) {
                              if(errorThrown == 'Forbidden') {
                                 window.location = '{$page}';
                              } else {
                                 alert(errorThrown);
                              }
                           }
                        });
                     }
                  });
                  // hide columns: commandid, categoryid, targetversionid, userid
                  oTable.fnSetColumnVis( 9, false );
                  oTable.fnSetColumnVis( 10, false );
                  oTable.fnSetColumnVis( 11, false );
                  oTable.fnSetColumnVis( 12, false );
                  oTable.fnSetColumnVis( 13, false );
                  jQuery("body").css('cursor','auto');
               });
            });
         </script>

         <button type='button' name="btImportIssues" id="btImportIssues"><img  border='0' align='absmiddle' src="images/b_save.gif" alt="Save icon"/> {t}Import{/t}</button>

      </div>
   {/if}



   

</div>