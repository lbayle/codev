<div id="content">
{if isset($isEditGranted) && $isEditGranted}

   <script type="text/javascript" src="js/datepicker.js"></script>
   <script type="text/javascript">
      jQuery(document).ready(function() {
         {if $locale != en}
         jQuery.datepicker.setDefaults($.datepicker.regional['{$locale}']);
         {/if}

         // Set the date
         var startDatePicker = null;
         {if isset($cmdStartDate)}
         startDatePicker = jQuery("#cmdStartDate").datepicker("setDate", "{$cmdStartDate}");
         {else}
         startDatePicker = jQuery("#cmdStartDate").datepicker();
         {/if}
         var endDatePicker = null;
         {if isset($cmdDeadline)}
         endDatePicker = jQuery("#cmdDeadline").datepicker("setDate", "{$cmdDeadline}");
         {else}
         endDatePicker = jQuery("#cmdDeadline").datepicker();
         {/if}

         // Add range date
         startDatePicker.datepicker("option","beforeShow",function(input) {
            jQuery(this).datepicker("option","maxDate",endDatePicker.datepicker("getDate"));
         });
         endDatePicker.datepicker("option","beforeShow",function(input) {
            jQuery(this).datepicker("option","minDate",startDatePicker.datepicker("getDate"));
         });
      });
   </script>

   <h2 class="center">{if isset($cmdName)}{$cmdName}{else}{t}New command{/t}{/if}</h2>

   <div style="margin-top: 2em;">
      <!-- create form -->
      <form id="updateCmdInfoForm" name="updateCmdInfoForm" class="formWithTabsHistory" method="post" action="{$page}">
         <fieldset>
            <table class="invisible">
               <tbody>
                  <tr>
                     <th><label for="teamSelector">{t}Team{/t}</label></th>
                     <td>
                        <select id="teamSelector" name="cmd_teamid">
                           <!--option value="0"></option-->
                           {foreach from=$grantedTeams key=id item=i}
                           <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                           {/foreach}
                        </select>
                        <span style="color:red">*</span>
                     </td>
                  </tr>
                  <tr>
                     <th><label for="cmdName">{t}Name{/t}</label></th>
                     <td>
                        <input type="text" size="80" style="font-family: sans-serif" name="cmdName" id="cmdName" value="{$cmdName}">
                        <span style="color:red">*</span>
                     </td>
                  </tr>
                  <tr>
                     <th><label for="cmdReference">{t}Reference{/t}</label></th>
                     <td><input type="text" style="font-family: sans-serif" name="cmdReference" id="cmdReference" value="{if isset($cmdReference)}{$cmdReference}{/if}"></td>
                  </tr>
                  <tr>
                     <th><label for="cmdVersion">{t}Version{/t}</label></th>
                     <td><input type="text" style="font-family: sans-serif" name="cmdVersion" id="cmdVersion" value="{if isset($cmdVersion)}{$cmdVersion}{/if}"></td>
                  </tr>
                  <tr>
                     <th><label for="cmdReporter">{t}Reporter{/t}</label></th>
                     <td><input type="text" style="font-family: sans-serif" name="cmdReporter" id="cmdReporter" value="{if isset($cmdReporter)}{$cmdReporter}{/if}"></td>
                  </tr>
                  <tr>
                     <th><label for="cmdDesc">{t}Description{/t}</label></th>
                     <td><textarea rows="4" cols="80" style="font-family: sans-serif" name="cmdDesc" id="cmdDesc">{if isset($cmdDesc)}{$cmdDesc}{/if}</textarea></td>
                  </tr>
                  <tr>
                     <th><label for="cmdStartDate">{t}Start date{/t}</label></th>
                     <td><input type="text" id="cmdStartDate" name="cmdStartDate" class="datepicker" maxlength="10" size="10" title="{t}Start date{/t}" />
                     </td>
                  </tr>
                  <tr>
                     <th><label for="cmdDeadline">{t}End date{/t}</label></th>
                     <td><input type="text" id="cmdDeadline" name="cmdDeadline" class="datepicker" maxlength="10" size="10" title="{t}Deadline{/t}" />
                     </td>
                  </tr>
                  <tr>
                     <th><label for="stateSelector">{t}State{/t}</label></th>
                     <td>
                        <select id="stateSelector" name="cmdState">
                           <option value="0"></option>
                           {foreach from=$cmdStateList key=id item=i}
                           <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                           {/foreach}
                        </select>
                     </td>
                  </tr>
                     <th><label for="cmdTotalSoldDays" title="MgrEE + Provisions">{t}Sold Charge{/t}</label></th>
                     <td><input type="text" style="font-family: sans-serif" name="cmdTotalSoldDays" id="cmdTotalSoldDays" value="{if isset($cmdTotalSoldDays)}{$cmdTotalSoldDays}{/if}"> {t}days{/t}
                     </td>
                  </tr>
                  <tr>
                     <th title="{t}Average Daily Rate{/t}"><label for="cmdAverageDailyRate">{t}Default ADR{/t}</label></th>
                     <td><input type="text" style="font-family: sans-serif" name="cmdAverageDailyRate" id="cmdAverageDailyRate" value="{if isset($cmdAverageDailyRate)}{$cmdAverageDailyRate}{/if}"> {t}EUR{/t}
                     </td>
                  </tr>
               </tbody>
            </table>
            <br />
            {if isset($commandid)}<button type="button" name="btDeleteCommand" id="btDeleteCommand"><img  border="0" align="absmiddle" src="images/b_drop.png" alt="Delete icon"/> {t}Delete{/t}</button>{/if}
            <button type="button" id="btSaveCommand"><img  border="0" align="absmiddle" src="images/b_save.png" alt="Save icon"/> {$cmdInfoFormBtText}</button>
            <input type="hidden" name="action" value="{$cmdInfoFormAction}" />
            {if isset($commandid)}<input type="hidden" name="cmdid" value="{$commandid}" />{/if}
         </fieldset>
      </form>

      <script type="text/javascript">
         jQuery(document).ready(function() {

            function checkRegexp(o, regexp, n) {
               if (!(regexp.test(o.val()))) {
                  //o.addClass("ui-state-error");
                  //updateTips(n);
                  return false;
               } else {
                  return true;
               }
            }

            jQuery("#btSaveCommand").click(function() {
               // check fields
               var foundError = 0;
               var msgString = "";

               var form = jQuery("#updateCmdInfoForm");
               if (0 == form.find("input[name=cmdName]").val().length) {
                  msgString += "{t}Field is missing{/t}: {t}Command name{/t}\n";
                  ++foundError;
               }
               if ('' != form.find("input[name=cmdTotalSoldDays]").val()) {
                  bValid = checkRegexp(form.find("input[name=cmdTotalSoldDays]"), /^[0-9]+(\.[0-9]+)?$/i, "format: '1234' or '123.35'");
                  if (!bValid) {
                     msgString += "{t}Not a number{/t}: {t}Sold Charge{/t}\n";
                     ++foundError;
                  }
               }
               if ('' != form.find("input[name=cmdAverageDailyRate]").val()) {
                  bValid = checkRegexp(form.find("input[name=cmdAverageDailyRate]"), /^[0-9]+(\.[0-9]+)?$/i, "format: '1234' or '123.35'");
                  if (!bValid) {
                     msgString += "{t}Not a number{/t}: {t}Default ADR{/t}\n";
                     ++foundError;
                  }
               }

               if (0 == foundError) {
                  form.submit();
               } else {
                  alert(msgString);
               }
            });
         });
      </script>

      {if isset($commandid)}
      <!-- DialogBox for deleteCommand -->
      <script type="text/javascript">
         jQuery(document).ready(function() {

            // DialogBox for deleteCommand
            jQuery("#btDeleteCommand").click(function(event) {
               jQuery("#deleteCommand_dialog_form").dialog("open");
            });

            // delete track dialogBox
            jQuery("#deleteCommand_dialog_form").dialog({
               autoOpen: false,
               resizable: true,
               width: "auto",
               modal: true,
               buttons: {
                  "{t}Delete{/t}": function() {
                     jQuery("#formDeleteCommand").submit();
                  },
                  Cancel: function() {
                     jQuery(this).dialog("close");
                  }
               }
            });
         });
      </script>
      <div id="deleteCommand_dialog_form" title="{t}Delete Command{/t}" class="ui-helper-hidden">
         <p><span class="ui-icon ui-icon-alert float" style="margin-right: 7px;"></span>{t}Delete this Command ?{/t}</p>
         <table class="invisible">
            <tbody>
               <tr>
                  <th nowrap="nowrap">{t}Reference{/t} :</th>
                  <td>{$cmdReference}</td>
               </tr>
               <tr>
                  <th nowrap="nowrap">{t}Name{/t} :</th>
                  <td id="desc_name">{$cmdName}</td>
               </tr>
               <tr>
                  <th nowrap="nowrap">{t}Nb tasks{/t} :</th>
                  <td id="desc_name">{$cmdNbIssues}</td>
               </tr>
               <tr>
                  <th valign="top" nowrap="nowrap">{t}CommandSets{/t} :</th>
                  <td>{foreach from=$parentCmdSets key=id item=i}{$i}<br />{/foreach}</td>
               </tr>
            </tbody>
         </table>
         <form id="formDeleteCommand" name="formDeleteCommand" method="post" action="{$page}" >
            <fieldset>
               <input type="hidden" name="action" value="deleteCommand" />
               <input type="hidden" name="commandid" value="{$commandid}" />
               <input type="hidden" name="teamid" value="{$teamid}" />
            </fieldset>
         </form>
      </div>
      {/if}
   </div>

   {if isset($cmdIssues) || isset($isAddCmdSetForm)}
   <div id="tabsCommand" class="tabs {$ui_tabs_jquery}" style="margin-top:2em;">
      <ul class="{$ui_tabs_jquery_ul}">
         <li class="{$ui_tabs_jquery_li}"><a href="#tab_tasks">{t}Tasks{/t} {if isset($cmdNbIssues)}({$cmdNbIssues}){/if}</a></li>
         <li class="{$ui_tabs_jquery_li}"><a href="#tab_wbs">{t}WBS{/t}</a></li>
         <li class="{$ui_tabs_jquery_li}"><a href="#tab_provisions">{t}Provisions{/t}</a></li>
         <li class="{$ui_tabs_jquery_li}"><a href="#tab_cmdsets">{t}Parent CommandSets{/t} {if isset($nbParentCmdSets)}({$nbParentCmdSets}){/if}</a></li>
      </ul>

      <div id="tab_tasks">
         {if isset($isAddIssueForm)}
         <script type="text/javascript">

            function IsNumeric(input)
            {
                return (input - 0) === input && (''+input).replace(/^\s+|\s+$/g, "").length > 0;
            }

            jQuery(document).ready(function() {
               jQuery("#btAddCmdIssue").click(function(event) {
                  addCmdIssue();
               });

               jQuery("#bugid").keypress(function(event) {
                  if ( jQuery.ui.keyCode.ENTER == event.keyCode ) {
                     addCmdIssue();
                     event.preventDefault();
                  }
               });

               function addCmdIssue(){
                  // check fields
                  var foundError = 0;
                  var msgString = "";
                  var bug_id = document.forms["addCmdIssueForm"].bugid.value;

                  if ("" == bug_id) {
                     msgString += "{t}Missing field{/t}:\n\n{t}task id{/t}\n";
                     ++foundError;
                  }
                  
                  if (!IsNumeric(bug_id)) {
                     msgString += "{t}Not a number{/t}:\n\n{t}task id{/t}\n";
                     ++foundError;
                  }


                  if (0 == foundError) {
                     document.forms["addCmdIssueForm"].submit();
                  } else {
                     alert(msgString);
                  }
               }
            });
         </script>

         <div>
            <!-- create form -->
            <form id="addCmdIssueForm" name="addCmdIssueForm" method="post" action="{$page}">
               <fieldset>
                  <label for="bugid">{t}Add task{/t}: </label>
                  <input id="bugid" name="bugid" type="text" size="5" value="" />
                  <button id="btAddCmdIssue" type="button"><img border="0" align="absmiddle" alt="Add icon" src="images/b_add.png"> {t}Add{/t}</button>
                  <input type="hidden" name="action" value="addCmdIssue" />
                  <input type="hidden" name="teamid" value="{$teamid}" />
                  <input type="hidden" name="cmdid" value="{$commandid}" />
               </fieldset>
            </form>
            {include file="modal/select_issues.html"}
         </div>
         {else}
         {t}Create the Command to add some tasks.{/t}
         {/if}

         {if isset($cmdIssues)}
         <div align="center">
            <table id="issues_table" class="datatable" style="width:100%">
               <thead>
                  <tr>
                     <th></th>
                     <th style="width: 1em;">{t}ID{/t}</th>
                     <th style="width: 1em;">{t}Project{/t}</th>
                     <th style="width: 1em;">{t}Target{/t}</th>
                     <th>{t}Summary{/t}</th>
                  </tr>
               </thead>
               <tbody>
                  {foreach $cmdIssues as $id => $issue}
                  <tr>
                     <td class="ui-state-error-text" style="width:1em;">
                        <a class="ui-icon" title="{t}delete Command-Task association{/t}" href="{$page}"
                           onclick="removeCmdIssue('{$id}', '{$issue.project}', '{$issue.summary|escape_all_quotes}');return false;">
                        </a>
                     </td>
                     <td style="width: 1em;">{$issue.bugid}</td>
                     <td style="width: 1em;">{$issue.project}</td>
                     <td style="width: 1em;" nowrap="nowrap">{$issue.target}</td>
                     <td>{$issue.summary}</td>
                  </tr>
                  {/foreach}
               </tbody>
            </table>

            <script type="text/javascript">
               function removeCmdIssue(bugid, project, description){
                  jQuery("#desc_id").text(bugid);
                  jQuery("#desc_project").text(project);
                  jQuery("#desc_summary").text(description);

                  jQuery("#formRemoveCmdIssue").find("input[name=bugid]").val(bugid);

                  jQuery("#removeCmdIssue_dialog_form").dialog( "open" );
               }

               jQuery(document).ready(function() {
                  // delete track dialogBox
                  jQuery("#removeCmdIssue_dialog_form").dialog({
                     autoOpen: false,
                     resizable: true,
                     width: "auto",
                     modal: true,
                     buttons: {
                        "{t}Remove{/t}": function() {
                           jQuery("#formRemoveCmdIssue").submit();
                        },
                        Cancel: function() {
                           jQuery(this).dialog("close");
                        }
                     }
                  });
               });
            </script>
            <div id="removeCmdIssue_dialog_form" title="{t}Remove Task{/t}" class="ui-helper-hidden">
               <p><span class="ui-icon ui-icon-alert float" style="margin-right: 7px;"></span>{t}Remove Task from this Command ?{/t}</p>
               <table class="invisible">
                  <tbody>
                     <tr>
                        <th nowrap="nowrap">{t}Id{/t} :</th>
                        <td id="desc_id">id</td>
                     </tr>
                     <tr>
                        <th nowrap="nowrap">{t}Project{/t} :</th>
                        <td id="desc_project">project</td>
                     </tr>
                     <tr>
                        <th nowrap="nowrap">{t}Summary{/t} :</th>
                        <td id="desc_summary">summary</td>
                     </tr>
                  </tbody>
               </table>
               <form id="formRemoveCmdIssue" name="formRemoveCmdIssue" method="post" action="{$page}" >
                  <fieldset>
                     <input type="hidden" name="action" value="removeCmdIssue" />
                     <input type="hidden" name="bugid"  value="0" />
                     <input type="hidden" name="teamid" value="{$teamid}" />
                     <input type="hidden" name="cmdid"  value="{$commandid}" />
                  </fieldset>
               </form>
            </div>
         </div>
         {/if}
      </div>

      <div id="tab_cmdsets">
         {if !isset($isAddCmdSetForm)}
         {t}Create the Command before assigning it to a CommandSet.{/t}
         {elseif 0 == count($parentCmdSetCandidates)}
         {t}No CommandSet found.{/t}
         {else}
         <div align="left">
            <!-- add/create command form -->
            <form id="addCmdSetForm" name="addCmdSetForm" method="post" action="{$page}">
               <fieldset>
                  <select id="commandsetSelector" name="commandsetid">
                     {foreach  $parentCmdSetCandidates as $id => $name}
                     <option value="{$id}">{$name}</option>
                     {/foreach}
                  </select>
                  <button type="submit"><img border="0" align="absmiddle" src="images/b_add.png" alt="Add icon"/> {t}Add{/t}</button>
                  <input type="hidden" name="action" value="addToCmdSet" />
                  <input type="hidden" name="teamid" value="{$teamid}" />
                  <input type="hidden" name="cmdid" value="{$cmdid}" />
               </fieldset>
            </form>
         </div>
         {/if}

         <div style="margin-top:1em;">
            {if isset($parentCmdSets)}
            <table>
               <thead>
                  <tr>
                     <th></th>
                     <th>{t}CommandSet{/t}</th>
                     <!-- <th>{t}Team{/t}</th> -->
                  </tr>
               </thead>
               <tbody>
                  {foreach $parentCmdSets as $id => $name}
                  <tr>
                     <td class="ui-state-error-text" style="width:1em;">
                        <a class="ui-icon" title="{t}delete CommandSet-Command association{/t}" href="{$page}"
                           onclick="removeCmdSet('{$id}', '{$name|escape}');return false;"></a>
                     </td>
                     <td title="{$id}">{$name}</td>
                     <!-- FIXME  No team set-->
                     <!-- <td>{$cmdset.team}</td> -->
                  </tr>
                  {/foreach}
               </tbody>
            </table>
            <script type="text/javascript">
               function removeCmdSet(commandsetid, name){
                  var dialog = jQuery("#removeCmdSet_dialog_form");
                  dialog.find(".desc_id").text(commandsetid);
                  dialog.find(".desc_name").text(name);

                  dialog.find("#formRemoveCmdSet").find("input[name=commandsetid]").val(commandsetid);

                  dialog.dialog("open");
               }

               jQuery(document).ready(function() {
                  // delete track dialogBox
                  jQuery("#removeCmdSet_dialog_form").dialog({
                     autoOpen: false,
                     resizable: true,
                     width: "auto",
                     modal: true,
                     buttons: {
                        "{t}Remove{/t}": function() {
                           jQuery("#formRemoveCmdSet").submit();
                        },
                        Cancel: function() {
                           jQuery(this).dialog("close");
                        }
                     }
                  });

               });
            </script>
            <div id="removeCmdSet_dialog_form" title="{t}Remove CommandSet{/t}" class="ui-helper-hidden">
               <p><span class="ui-icon ui-icon-alert float" style="margin-right: 7px;"></span>{t}Remove this Command from the CommandSet ?{/t}</p>
               <table class="invisible">
                  <tbody>
                     <tr>
                        <th nowrap="nowrap">{t}Id{/t} :</th>
                        <td class="desc_id">id</td>
                     </tr>
                     <tr>
                        <th nowrap="nowrap">{t}Name{/t} :</th>
                        <td class="desc_name">name</td>
                     </tr>
                  </tbody>
               </table>
               <form id="formRemoveCmdSet" name="formRemoveCmdSet" method="post" action="{$page}" >
                  <fieldset>
                     <input type="hidden" name="action" value="removeFromCmdSet" />
                     <input type="hidden" name="teamid" value="{$teamid}" />
                     <input type="hidden" name="commandsetid"  value="0" />
                  </fieldset>
               </form>
            </div>
            {else}
            {t}Create the Command first.{/t}
            {/if}
         </div>
      </div>
      <div id="tab_provisions">
         <div style="display:inline-block">
            <script type="text/javascript">
               // actions for 'provisionsTable'

               jQuery(document).ready(function() {
                  jQuery(".cbIsInCheckBudget").click(function () {
                     jQuery("#btSaveProvisions").removeAttr("disabled");
                  });

                  jQuery("#btSaveProvisions").click(function() {

                     var imploded = ""
                     jQuery("#provisionsTable tbody tr").each(function() {
                        var provid = jQuery(this).attr("id");
                        var isInCheckBudget = jQuery(this).find(".cbIsInCheckBudget").attr("checked");
                        var boolVal = ("checked" == isInCheckBudget) ? 1 : 0;

                        imploded += provid+":"+boolVal+",";
                        //alert("provid " + provid + " implode "+ implode);
                     });

                     var myform = jQuery("#formSaveProvisionChanges");
                     myform.find("input[name=isInCheckBudgetImploded]").val(imploded);
                     myform.submit(); // this 'submit' method is rewritten for ajax purpose, see below

                     jQuery("#btSaveProvisions").attr("disabled", "disabled");
                  });

                  // rewrite the 'submit' method to send the request in background (async) via ajax
                  jQuery("#formSaveProvisionChanges").submit(function(event) {

                     event.preventDefault(); // stop form from submitting normally

                     var myform = jQuery(this);
                     jQuery.ajax({
                        // standard 'submit' attributes:
                        type: myform.attr("method"),
                        url: myform.attr("action"),
                        data: myform.serialize(),
                        // add specific actions:
                        success: function(data) {
                           // 'data' is returned by the ajax page (using PHP 'echo' function)
                           if ('SUCCESS' == data) {
                              alert("{t}Provisions successfully updated.{/t}");
                           } else {
                              // data = error message
                              alert(data);
                              window.location = '{$page}';
                           }
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                           if(errorThrown == 'Forbidden') {
                              window.location = '{$page}';
                           } else {
                              alert({t}errorThrown{/t});
                           }
                        }
                     });


                  });

               });

               function deleteProvision(provid, date, type, budget, budgetDays, summary){
                  var dialog = jQuery("#deleteProvision_dialog_form");
                  dialog.find(".desc_date").text(date);
                  dialog.find(".desc_type").text(type);
                  dialog.find(".desc_budget").text(budget);
                  dialog.find(".desc_budgetDays").text(budgetDays);
                  dialog.find(".desc_summary").text(summary);
                  dialog.find("input[name=provid]").val(provid);

                  dialog.dialog("open");
               }
            </script>
            <form id="formSaveProvisionChanges" name="formSaveProvisionChanges" method="post" action="{$ajaxPage}" >
               <fieldset>
                  <input type="hidden" name="action" value="saveProvisionChanges" />
                  <input type="hidden" name="teamid" value="{$teamid}" />
                  <input type="hidden" name="cmdid" value="{$cmdid}" />
                  <input type="hidden" name="isInCheckBudgetImploded" value="0" />
               </fieldset>
            </form>

            <div>
               <button id="btAddProvision" type="button"><img border="0" align="absmiddle" alt="Add icon" src="images/b_add.png"> {t}Add Provision{/t}</button>
               <button id="btSaveProvisions" disabled="disabled" type="button" class="floatr"><img  border="0" align="absmiddle" src="images/b_save.png" alt="Save icon"/> {t}Save{/t}</button>
            </div>
            <table id="provisionsTable">
               <thead>
               <tr>
                  <th></th>
                  <th>{t}Date{/t}</th>
                  <th>{t}Type{/t}</th>
                  <th>{t}Budget Days{/t}</th>
                  <th>{t}Budget{/t}</th>
                  <th title="{t}Average Daily Rate{/t}">{t}ADR{/t}</th>
                  <th>{t}Summary{/t}</th>
                  <th title = "{t}add to budget check{/t}"></th>
               </tr>
               </thead>
               <tbody>
               {foreach $cmdProvisionList as $id => $prov}
               <tr id="{$id}">
                  <td class="ui-state-error-text" style="width:1em;">
                     <a class="ui-icon" title="{t}delete Provision{/t}" href="{$page}"
                        onclick="deleteProvision('{$prov.id}', '{$prov.date}', '{$prov.type}', '{$prov.budget} {$prov.currency}', '{$prov.budget_days} {t}days{/t}', '{$prov.summary}');return false;"></a>
                  </td>
                  <td>{$prov.date}</td>
                  <td>{$prov.type}</td>
                  <td>{$prov.budget_days}</td>
                  <td>{$prov.budget} {$prov.currency}</td>
                  <td>{$prov.average_daily_rate}</td>
                  <td>{$prov.summary}</td>
                  <td title="{t}add to budget check{/t}"><input {if ($prov.isInCheckBudget)}checked="checked"{/if} type="checkbox" class="cbIsInCheckBudget" /></td>
               </tr>
               {/foreach}
               </tbody>
            </table>
         </div>

         <script type="text/javascript">
            // actions for 'addProvision_dialog_form'

            function updateADR() {
               if (('' != jQuery("#budget").val()) &&
                  (0 != jQuery("#budget").val()) &&
                  ('' != jQuery("#budgetDays").val()) &&
                  (0 != jQuery("#budgetDays").val())
               ) {
                  var adr = parseFloat(jQuery("#budget").val()) / parseFloat(jQuery("#budgetDays").val());
                  jQuery("#averageDailyRate").val(adr.toFixed(2));
               }
            }
            function updateBudget() {
               if (('' != jQuery("#averageDailyRate").val()) &&
                  (0 != jQuery("#averageDailyRate").val()) &&
                  ('' != jQuery("#budgetDays").val()) &&
                  (0 != jQuery("#budgetDays").val())
               ) {
                  var budget = parseFloat(jQuery("#budgetDays").val()) * parseFloat(jQuery("#averageDailyRate").val());
                  jQuery("#budget").val(budget.toFixed(2));
               }
            }


            jQuery(document).ready(function() {

               jQuery("#budgetDays").keyup(function(event) {
                  updateBudget();
               });

               jQuery("#averageDailyRate").keyup(function(event) {
                  updateBudget();
               });

               jQuery("#budget").keyup(function(event) {
                  updateADR();
               });

               jQuery("#type").change(function() {

                  // DEFAULT: checked, except if type='management'
                  var checked = ( jQuery("#type").val() == {$cmdProvisionTypeMngt}) ? false : true;
                  jQuery("#cb_isInCheckBudget").prop('checked', checked);
               });

               jQuery("#btAddProvision").click(function(event) {
                  var dialog = jQuery("#addProvision_dialog_form");
                  dialog.dialog("open");
               });

               // add provision dialogBox
               jQuery("#addProvision_dialog_form").dialog({
                  autoOpen: false,
                  resizable: true,
                  width: "auto",
                  modal: true,
                  buttons: {
                     "{t}Add{/t}": function() {
                        var isInCheckBudget = jQuery("#cb_isInCheckBudget").attr('checked')?1:0;
                        var form = jQuery("#formAddProvision");
                        form.find("input[name=isInCheckBudget]").val(isInCheckBudget);
                        form.submit();
                     },
                     Cancel: function() {
                        jQuery(this).dialog("close");
                     }
                  }
               });
               // delete provision dialogBox
               jQuery("#deleteProvision_dialog_form").dialog({
                  autoOpen: false,
                  resizable: true,
                  width: "auto",
                  modal: true,
                  buttons: {
                     "{t}Delete{/t}": function() {
                        jQuery("#formDeleteProvision").submit();
                     },
                     Cancel: function() {
                        jQuery(this).dialog("close");
                     }
                  }
               });
            });
         </script>

         <div id="addProvision_dialog_form" title="{t}Add Provision{/t}" class="ui-helper-hidden">
            <form id="formAddProvision" name="formAddProvision" method="post" action="{$page}" class="formWithTabsHistory" >
               <fieldset>
                  <table class="invisible">
                     <tbody>
                        <tr>
                           <th nowrap="nowrap"><label for="datepicker">{t}Date{/t} :</label></th>
                           <td><input type="text" id="datepicker" class="datepicker" name="date" maxlength="10" size="10" title="{t}Date{/t}" /></td>

                        </tr>
                        <tr>
                           <th nowrap="nowrap"><label for="type">{t}Type{/t}: </label></th>
                           <td>
                              <select id="type" name="type">
                              {foreach from=$cmdProvisionType key=id item=i}
                                 <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                              {/foreach}
                              </select>
                           <td>
                        </tr>
                        <tr>
                           <th nowrap="nowrap"><label for="budgetDays">{t}Budget Days{/t} :</label></th>
                           <td><input type="text" id="budgetDays" name="budgetDays" size="10" class="text" value="" /></td>
                        </tr>
                        <tr>
                           <th nowrap="nowrap"><label for="averageDailyRate">{t}Average Daily Rate{/t} :</label></th>
                           <td><input type="text" id="averageDailyRate" name="averageDailyRate" size="10" class="text" value="" />
                              EUR
                           </td>
                        </tr>
                        <tr>
                           <th nowrap="nowrap"><label for="budget">{t}Budget{/t} :</label></th>
                           <td><input type="text" id="budget" name="budget" size="10" class="text" value="" />
                              EUR
                              <!--select id="currency" name="currency">
                              {foreach from=$provisionCurrency key=id item=i}
                                 <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                              {/foreach}
                              </select-->
                           </td>
                        </tr>
                        <tr>
                           <th nowrap="nowrap"><label for="summary">{t}Summary{/t} :</label></th>
                           <td><input type="text" id="summary" name="summary" size="80" class="text" /></td>
                        </tr>
                        <tr>
                           <th nowrap="nowrap"><label for="cb_isInCheckBudget">{t}Add to 'check budget'{/t} :</label></th>
                           <td><input type="checkbox" id="cb_isInCheckBudget" /></td>
                        </tr>

                     </tbody>
                  </table>
                  <input type="hidden" name="prov_summary" value="0" />
                  <input type="hidden" name="action" value="addProvision" />
                  <input type="hidden" name="teamid" value="{$teamid}" />
                  <input type="hidden" name="commandid" value="{$cmdid}" />
                  <input type="hidden" name="isInCheckBudget" value="{$isInCheckBudget}"/>
               </fieldset>
            </form>
         </div>

         <div id="deleteProvision_dialog_form" title="{t}Delete Provision{/t}" class="ui-helper-hidden">
            <form id="formDeleteProvision" name="formDeleteProvision" method="post" action="{$page}" class="formWithTabsHistory" >
               <p><span class="ui-icon ui-icon-alert float" style="margin-right: 7px;"></span>{t}Delete from the Command ?{/t}</p>
               <fieldset>
                  <table class="invisible">
                     <tbody>
                        <tr>
                           <th nowrap="nowrap">{t}Date{/t} :</th>
                           <td class="desc_date">date</td>
                        </tr>
                        <tr>
                           <th nowrap="nowrap">{t}Type{/t} :</th>
                           <td class="desc_type">type</td>
                        </tr>
                        <tr>
                           <th nowrap="nowrap">{t}Budget{/t} :</th>
                           <td class="desc_budget"></td>
                        </tr>
                        <tr>
                           <th nowrap="nowrap">{t}Budget Days{/t} :</th>
                           <td class="desc_budgetDays"></td>
                        </tr>
                        <tr>
                           <th nowrap="nowrap">{t}Summary{/t} :</th>
                           <td class="desc_summary">summary</td>
                        </tr>
                     </tbody>
                  </table>
                  <input type="hidden" name="action" value="deleteProvision" />
                  <input type="hidden" name="teamid" value="{$teamid}" />
                  <input type="hidden" name="provid"  value="0" />
               </fieldset>
            </form>
         </div>
      </div>

      <div id="tab_wbs">
          {include file="tools/wbsEditor.html"}
      </div>

      <script type="text/javascript">
         jQuery(document).ready(function() {
            jQuery.ajax({
               url: "js_min/datatable.min.js",
               dataType: "script",
               cache: true
            });
         });
      </script>
   </div>
   {/if}
{else}
   <div class="center">
   {t}Sorry, only managers can access this page.{/t}
   </div>
{/if}
</div>
