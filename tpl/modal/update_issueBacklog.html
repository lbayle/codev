
<div id="update_backlog_dialog_form" title="Task XXX - Update Backlog" class="ui-helper-hidden">
   <p class="issue_summary">issue_summary</p>
   <form id="formUpdateBacklog" name="formUpdateBacklog" method="post" action="timetracking/time_tracking_ajax.php" >
      <fieldset>
         <table class="invisible">
            <tbody>
               <tr>
                  <th><label for="status">{t}Status{/t} :</label></th>
                  <td>
                     <select id="status" name="status"> </select>
                  </td>
               </tr>
               <tr id="tr_deadline">
                  <th>{t}Deadline{/t} :</th>
                  <td id="desc_deadline">date</td>
               </tr>
               <tr>
                  <th>{t}Estimated effort{/t} :</th>
                  <td id="desc_effortEstim">effortEstim</td>
               </tr>
               <tr>
                  <th>{t}Elapsed{/t} :</th>
                  <td id="desc_elapsed">elapsed</td>
               </tr>
               <tr>
                  <th>{t}Effort Deviation{/t} :</th>
                  <td id="desc_drift">drift</td>
               </tr>
               <tr>
                  <th><label for="backlog">{t}Backlog{/t} :</label></th>
                  <td><input type="text" id="backlog" name="backlog" size="3" class="text" /></td>
                  <td><label id="validateTips" class="error_font" ></label></td>
                  </td>
               </tr>
            </tbody>
         </table>

         <input type="hidden" name="bugid"  value="0" />
         <input type="hidden" name="action" value="updateBacklogAction" />
         {if isset($userid)}<input type="hidden" name="userid" value="{$userid}" />{/if}
         <input type="hidden" name="weekid" value="{$weekid}" />
         <input type="hidden" name="year" value="{$year}" />
         <input type="hidden" name="statusid" value="" />
         <input type="hidden" name="bugResolvedStatusThreshold" id="bugResolvedStatusThreshold" value="" />
      </fieldset>
   </form>

	<form id="formGetUpdateBacklogData" name="formGetUpdateBacklogData" method="get" action="{$ajaxPage}" >
		<fieldset>
			<input type="hidden" name="action" value="getUpdateBacklogData" />
			<input type="hidden" name="bugid" value="" />
		</fieldset>
	</form>
</div>


<script type="text/javascript">

	jQuery(document).ready(function() {

		function updateBacklog(bugid){
			// ajax call to get DialogBox data
			var formGetUpdateBacklogData = jQuery('#formGetUpdateBacklogData');
			jQuery("#formGetUpdateBacklogData").find("input[name=bugid]").val(bugid);

			jQuery.ajax({
				type: "GET",
				dataType:"json",
				url: formGetUpdateBacklogData.attr("action"),
				data: formGetUpdateBacklogData.serialize(),
				success: function(data) {
					openUpdateBacklogDialogbox(data);
				},
				error: function(data) {
					// TODO
					alert('ERROR: ' + data);
				}
			});
		}

		function openUpdateBacklogDialogbox(updateBacklogJsonData){

			var data = updateBacklogJsonData;

			// do not display computed backlog: force users to reestimate it !
			//jQuery("#backlog").val(data['backlog']);

			jQuery("#update_backlog_dialog_form").find(".issue_summary").text(data['summary']);
			jQuery("#desc_effortEstim").text(data['effortEstim']);
			jQuery("#desc_elapsed").text(data['elapsed']);
			//jQuery("#desc_reestimated").text(data['reestimated']);
			jQuery("#desc_drift").text(data['drift']);

			if (data.hasOwnProperty("deadline")) {
				jQuery("#desc_deadline").text(data['deadline']);
				jQuery("#tr_deadline").show();
			} else {
				jQuery("#tr_deadline").hide();
			}

			jQuery("#desc_drift").css("backgroundColor", '#' + data['driftColor']);

			jQuery("#formUpdateBacklog").find("input[name=bugid]").val(data['bugid']);
			jQuery("#formUpdateBacklog").find("input[name=bugResolvedStatusThreshold]").val(data['bugResolvedStatusThreshold']);

			var dialogBoxTitle = '{t}Task{/t} ' + data['dialogBoxTitle'] + ' - {t}Update Backlog{/t}'
			jQuery("#update_backlog_dialog_form").dialog("option", "title", dialogBoxTitle);

			// set available status
			jQuery('#status').empty();
			var availItemList = data['availableStatusList'];
			for (var id in availItemList) {

				if (availItemList.hasOwnProperty(id)) {
					if (id == data['currentStatus']) {
						jQuery('#status').append(
							jQuery('<option>').attr('id', id).attr('selected', 'selected').append(availItemList[id])
						);
					} else {
						jQuery('#status').append(
							jQuery('<option>').attr('id', id).append(availItemList[id])
						);
					}
				}
			}

			jQuery("#update_backlog_dialog_form").dialog("open");
		}

		// TODO get #backlog via form.search()
		var backlog = jQuery("#backlog"),
			 tips = jQuery("#validateTips"),
			 allFields = jQuery([]).add(backlog);

		function updateTips(t) {
			tips.text(t);
			//tips.addClass("ui-state-highlight");
			//setTimeout(function() {
			//   tips.removeClass("ui-state-highlight", 1500);
			//}, 500);
		}

		function checkRegexp(o, regexp, n) {
			if (!(regexp.test(o.val()))) {
				o.addClass("ui-state-error");
				updateTips(n);
				return false;
			} else {
				return true;
			}
		}

		function checkStatus(backlog, selectedStatus, bugResolvedStatusThreshold, msg) {
			if ((selectedStatus < bugResolvedStatusThreshold) && (0 == backlog.val())) {
				backlog.addClass("ui-state-error");
				updateTips(msg);
				return false;
			} else {
				return true;
			}
		}

		jQuery("#update_backlog_dialog_form").dialog({
			autoOpen: false,
			dialogClass: 'no-close',
			height: 'auto',
			width: 500,
			modal: true,
			closeOnEscape: false,
			open: function() {
				// Select input field contents
				jQuery("#backlog").select();
			},
			buttons: {
				"Update": function() {
					jQuery("#formUpdateBacklog").submit();
				}
				//,
				//Cancel: function() {
				//   jQuery( this ).dialog("close");
				//}
			},
			close: function() {
				allFields.val("").removeClass("ui-state-error");
				allFields.css("backgroundColor", "transparent");
			}
		});

		jQuery("#formUpdateBacklog").submit(function(event) {
			/* stop form from submitting normally */
			event.preventDefault();

			var bValid = true;
			allFields.removeClass("ui-state-error");
			bValid = bValid && checkRegexp(backlog, /^[0-9]+(\.[0-9]5?)?$/i, "format:  '1',  '0.3'  or  '2.55'");

			var bugResolvedStatusThreshold = jQuery("#bugResolvedStatusThreshold").val();
			var selectedStatus = jQuery("#status").children(":selected").attr("id");
			bValid = bValid && checkStatus(backlog, selectedStatus, bugResolvedStatusThreshold, "{t}Task not resolved, backlog cannot be '0'{/t}");


			if (bValid) {
				/* get some values from elements on the page: */
				var formUpdateBacklog = jQuery(this);
				formUpdateBacklog.find("input[name=year]").val(jQuery("#year").val());
				formUpdateBacklog.find("input[name=statusid]").val(selectedStatus);

				jQuery.ajax({
					type: "GET",
					url: formUpdateBacklog.attr("action"),
					data: formUpdateBacklog.serialize(),
					success: function(data) {
						jQuery("#weekTaskDetailsDiv").html(jQuery.trim(data));
						updateWidgets("#weekTaskDetailsDiv");
					}
				});

				jQuery("#update_backlog_dialog_form").dialog("close");
			}
		});

		// click on updateBacklog in timesheet
		jQuery('.js-updateBacklog-link').click(function(ev){
			ev.preventDefault();
			var bugId = this.getAttribute('data-bugId');
			updateBacklog(bugId);
			return false;
		});


		// on page reload (after a click on 'AddTrack' button), raise the updateBacklog dialogBox
		{if isset($updateBacklogJsonData)}
			openUpdateBacklogDialogbox({$updateBacklogJsonData});
		{/if}

	});

</script>
