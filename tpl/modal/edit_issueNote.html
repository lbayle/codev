<!--
This opens a popup window displaying an IssueNote text to edit.

-->

<div id="dialog_editIssueNote" title="Task XXX - Edit timesheet note" class="ui-helper-hidden">

   <label id="editIssueNoteDialogDesc" class="help_font"></label>
   <br><br>
   <textarea id="issuenote_text" name="issuenote_text" cols="80" rows="8"></textarea>

   <div align='left'>
      <form id="formEditIssueNote" name="formEditIssueNote" method="post" action="{$ajaxPage}" >
         <fieldset>
            <input type="hidden" name="action" value="saveIssueNote" />
            <input type="hidden" name="bugid" value="" />
            <input type="hidden" name="issuenoteid" value="" />
            <input type="hidden" name="issuenotetext_b64" value="" />

            {if isset($userid)}<input type="hidden" name="userid" value="{$userid}" />{/if}
            <input type="hidden" name="weekid" value="{$weekid}" />
            <input type="hidden" name="year" value="{$year}" />
         </fieldset>
      </form>
      <form id="formGetIssueNoteText" name="formGetIssueNoteText" method="get" action="{$ajaxPage}" >
         <fieldset>
            <input type="hidden" name="action" value="getIssueNoteText" />
            <input type="hidden" name="bugid" value="" />
         </fieldset>
      </form>
      <form id="formMarkIssueNoteAsRead" name="formMarkIssueNoteAsRead" method="get" action="{$ajaxPage}" >
         <fieldset>
            <input type="hidden" name="action" value="markIssueNoteAsRead" />
            <input type="hidden" name="bugid" value="" />
         </fieldset>
      </form>
   </div>
</div>

<!--script src='lib/jquery.base64/jquery.base64.js'></script-->

<script type="text/javascript">

   // function called when clicked on note icon
   function editIssueNote(bugid){

      // get note via ajax, to be sure that data is up to date.
      var formGetIssueNoteText = jQuery('#formGetIssueNoteText');
      formGetIssueNoteText.find("input[name=bugid]").val(bugid);
      jQuery.ajax({
         type: "GET",
         url: formGetIssueNoteText.attr("action"),
         data: formGetIssueNoteText.serialize(),
         success: function(data) {

            // decode json data
            var response = jQuery.parseJSON(data);

            // update dialogbox textarea
            var issuenoteid = response['issuenoteid']
            if (0 != issuenoteid) {
               var issuenote_text = jQuery.base64.decode(response['issuenote_text_b64']);
               jQuery("#dialog_editIssueNote").find("textarea[name=issuenote_text]").val(issuenote_text);
            }
            jQuery("#formEditIssueNote").find("input[name=bugid]").val(bugid);
            jQuery("#formEditIssueNote").find("input[name=issuenoteid]").val(issuenoteid);

            var dialogBoxTitle = '{t}Task{/t} ' + bugid + ' - {t}Edit timesheet note{/t}'
            jQuery("#dialog_editIssueNote").dialog("option", "title", dialogBoxTitle);

            jQuery("#editIssueNoteDialogDesc").text("Task " + bugid );

         },
         error: function(data) {
            // TODO
            alert('ERROR: ' + data);
         }
      });

      jQuery("#dialog_editIssueNote").dialog("open");
   }

   function markIssueNoteAsRead(bugid) {
      var formMarkIssueNoteAsRead = jQuery('#formMarkIssueNoteAsRead');
      formMarkIssueNoteAsRead.find("input[name=bugid]").val(bugid);
      jQuery.ajax({
         type: "GET",
         url: formMarkIssueNoteAsRead.attr("action"),
         data: formMarkIssueNoteAsRead.serialize(),
         success: function(data) {

            // decode json data
            //var response = jQuery.parseJSON(data);

            // TODO update IssueNote DataTable

         },
         error: function(data) {
            // TODO
            alert('ERROR: ' + data);
         }
      });
   }

   jQuery(document).ready(function() {

      var dialog = jQuery("#dialog_editIssueNote").dialog({
            autoOpen: false,
            modal: true,
            hide: "fade",
            height: 'auto',
            width: "auto",
            closeOnEscape: true,
            buttons: {
               Ok: function() {
//alert("call formEditIssueNote submit START");
                  jQuery("#formEditIssueNote").submit();
//alert("call formEditIssueNote submit END");
                  jQuery("#dialog_editIssueNote").find("textarea[name=issuenote_text]").val('');
                  jQuery("#dialog_editIssueNote").dialog("close");
               },
               Cancel: function() {
                  jQuery("#dialog_editIssueNote").find("textarea[name=issuenote_text]").val('');
                  jQuery( this ).dialog("close");
               }
            }
      });

      jQuery("#formEditIssueNote").submit(function(event) {
         /* stop form from submitting normally */
         event.preventDefault();
//alert("submit formEditIssueNote");
         /* get some values from elements on the page: */
         var formEditIssueNote = jQuery(this);
         var issuenotetext = jQuery("#dialog_editIssueNote").find("textarea[name=issuenote_text]").val();
         var issuenotetext_b64 = jQuery.base64.encode(issuenotetext);
         formEditIssueNote.find("input[name=issuenotetext_b64]").val(issuenotetext_b64);

         jQuery.ajax({
            type: "GET",
            url: formEditIssueNote.attr("action"),
            data: formEditIssueNote.serialize(),
            success: function(data) {
               // cannot update all tooltips, the complete table must be updated
               jQuery("#weekTaskDetailsDiv").html(jQuery.trim(data));
               updateWidgets("#weekTaskDetailsDiv");
            },
            error: function(data) {
               // TODO
               alert('ERROR: ' + data);
            }
         });
      });

   });

</script>
