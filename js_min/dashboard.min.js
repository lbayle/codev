function addDashboardPlugin(){jQuery(".cbPluginCandidates > option").each(function(){jQuery(".cbPluginCandidates option[value="+this.value+"]").show()});jQuery(".attributesJsonStr").each(function(){var attributesJson=jQuery.parseJSON($(this).text());var pClassName=attributesJson["pluginClassName"];jQuery(".cbPluginCandidates option[value="+pClassName+"]").hide()});jQuery(".cbPluginCandidates option[value='0']").attr("selected","selected");jQuery(".pluginDescription").html("");jQuery(".pluginAttributes").html("");jQuery(".addDashboardErrorMsg").html("");jQuery(".pluginConfig").hide();jQuery(".dashboardDialog_btAdd .ui-button-text").html(dashboardSmartyData.i18n_Add);jQuery(".dialogAddDashboardPlugin").dialog("open")}function saveDashboard(){console.log("saveDashboard");var widgetAttributes=[];jQuery(".widget:has(.attributesJsonStr)").each(function(){var $widget=$(this);if(true!==$widget.data("isSlidingUp")){var attributesJson=jQuery.parseJSON($widget.find(".attributesJsonStr").html());widgetAttributes.push(attributesJson)}});var dashboardSettingsJson={};dashboardSettingsJson["dashboardTitle"]=dashboardSmartyData.dashboardTitle;dashboardSettingsJson["displayedPlugins"]=widgetAttributes;var dashboardSettingsJsonStr=JSON.stringify(dashboardSettingsJson);jQuery.ajax({type:"POST",url:"include/dashboard_ajax.php",dataType:"json",data:{action:"saveDashboardSettings",dashboardId:dashboardSmartyData.dashboardId,dashboardSettingsJsonStr:dashboardSettingsJsonStr,isTeamDefaultSettings:"0"},success:function(data){if(null===data){alert("ERROR: could not save dashboard settings, please contact your administrator")}else if("SUCCESS"!==data.statusMsg){alert(data.statusMsg)}},error:function(jqXHR,textStatus,errorThrown){console.error(textStatus,errorThrown);alert("ERROR saveDashboardSettings: "+errorThrown)}})}jQuery(document).ready(function(){jQuery(".cbPluginCandidates").change(function(){if("0"!==this.value){jQuery(".addDashboardErrorMsg").html("");jQuery.ajax({type:"POST",url:"include/dashboard_ajax.php",dataType:"json",data:{pluginClassName:this.value,action:"getPluginConfigInfo",dashboardId:dashboardSmartyData.dashboardId},success:function(data){if(null===data){jQuery(".addDashboardErrorMsg").html("ERROR: could not get plugin configuration info,<br> please contact your administrator");jQuery(".pluginDescription").html("");jQuery(".pluginAttributes").html("");jQuery(".pluginConfig").hide()}else{if("SUCCESS"!==data.statusMsg){jQuery(".pluginDescription").html("");jQuery(".pluginAttributes").html("");jQuery(".pluginConfig").hide();jQuery(".addDashboardErrorMsg").html(data.statusMsg)}else{jQuery(".pluginDescription").html(data["description"]);jQuery(".pluginAttributes").html(jQuery.trim(data["attributesHtml"]));jQuery(".pluginConfig").show()}}},error:function(){jQuery(".pluginDescription").html("");jQuery(".pluginAttributes").html("");jQuery(".pluginConfig").hide();jQuery(".addDashboardErrorMsg").html("ERROR getPluginConfigInfo: please contact your administrator")}})}else{jQuery(".pluginDescription").html("");jQuery(".pluginAttributes").html("");jQuery(".pluginConfig").hide();jQuery(".addDashboardErrorMsg").html("")}});jQuery(".dialogAddDashboardPlugin").dialog({autoOpen:false,resizable:true,width:"auto",modal:true,create:function(){$(this).closest(".ui-dialog").find(".ui-button:first").addClass("dashboardDialog_btAdd")},buttons:[{text:dashboardSmartyData.i18n_Add,click:function(){jQuery(".dashboardDialog_btAdd .ui-button-text").html("<img src='images/spinner.gif' width='16' height='16' alt='"+dashboardSmartyData.i18n_loading+"' />");var ajaxFieldSelector="[type=hidden]";var form=$(".formAddDashboardPlugin");var $pluginElements=form.find(":input:not("+ajaxFieldSelector+")");var formElements=form.find(":input"+ajaxFieldSelector);var pluginAttributesArray=$pluginElements.serializeArray();var uncheckedElements=$pluginElements.filter("input[type=checkbox]:not(:checked)");var uncheckedElementsArray=uncheckedElements.map(function(i,checkbox){return{name:checkbox.name,value:0}}).get();pluginAttributesArray=pluginAttributesArray.concat(uncheckedElementsArray);var pluginOptionsJSONString=JSON.stringify(pluginAttributesArray);var formElements=form.find(":input"+ajaxFieldSelector);formElements.filter("[name=pluginAttributesJsonStr]").val(pluginOptionsJSONString);var dataToSend=formElements.serializeArray();$.ajax({url:"include/dashboard_ajax.php",type:form.attr("method"),dataType:"json",data:dataToSend,success:function(data){if(null===data){jQuery(".addDashboardErrorMsg").html("ERROR: could not load plugin, please contact your administrator");jQuery(".dashboardDialog_btAdd .ui-button-text").html(dashboardSmartyData.i18n_Add)}else{if("SUCCESS"!==data.statusMsg){jQuery(".addDashboardErrorMsg").html(data.statusMsg);jQuery(".dashboardDialog_btAdd .ui-button-text").html(dashboardSmartyData.i18n_Add)}else{var widget=data.widget;jQuery("<link/>",{rel:"stylesheet",type:"text/css",href:"lib/inettuts/inettuts_codevtt.css"}).appendTo("head");jQuery.each(widget.cssFiles,function(index,value){jQuery("<link/>",{rel:"stylesheet",type:"text/css",href:value}).appendTo("head")});var ulObj=jQuery(".inettuts-column1");var liObj=jQuery("<li></li>").addClass("widget").addClass(widget.color).attr("id",widget.id);var divHeadObj=jQuery("<div></div>").addClass("widget-head").append(jQuery("<h3></h3>").html(widget.title));var divContentObj=jQuery("<div></div>").addClass("widget-content").html(widget.content);var divObj=jQuery('<div style="display: none;" class="attributesJsonStr"/>').html(widget.attributesJsonStr);divObj.addClass(widget.pClassName+"Attr");liObj.append(divObj).append(divHeadObj).append(divContentObj);ulObj.prepend(liObj);jQuery.ajax({async:false,url:"lib/inettuts/inettuts_codevtt.min.js",dataType:"script"});jQuery.each(widget.jsFiles,function(index,value){jQuery.ajax({async:false,url:value,dataType:"script"})});var functionName=jQuery(widget.content).find(".pluginInitFunction").text();window[functionName]();divContentObj.find("#jqplot_target_1").attr("id","jqplot_target_"+widget.id);saveDashboard();jQuery(".addDashboardErrorMsg").html("");jQuery(".dialogAddDashboardPlugin").dialog("close")}}},error:function(data){console.error("ERROR data = ",data);jQuery(".dashboardDialog_btAdd .ui-button-text").html(dashboardSmartyData.i18n_Add);jQuery(".addDashboardErrorMsg").html("AddDashboardPlugin ERROR!")}})}},{text:dashboardSmartyData.i18n_Cancel,click:function(){jQuery(".addDashboardErrorMsg").html("");jQuery(this).dialog("close")}}]});jQuery(".inettuts-columns").on("click",".collapse",function(){var widget=$(this).closest(".widget");var wcontent=widget.children(".widget-content");var isCollapsed=!wcontent.is(":visible");var attr=widget.children(".attributesJsonStr");var attributesJson=jQuery.parseJSON(attr.text());attributesJson["isCollapsed"]=isCollapsed;var attributesJsonStr=JSON.stringify(attributesJson);attr.text(attributesJsonStr);if(!isCollapsed){var initFct=widget.find(".pluginInitFunction").text();window[initFct]()}console.warn("TODO collapse: do not save at page load, only on user click !");saveDashboard()});jQuery(".remove").click(function(){saveDashboard()});jQuery(".pluginInitFunction").each(function(){var widget=$(this).closest(".widget");var attr=widget.children(".attributesJsonStr");var attributesJson=jQuery.parseJSON(attr.text());var isCollapsed=attributesJson["isCollapsed"];if(isCollapsed){widget.find(".collapse").trigger("click")}var initFct=this.innerHTML;window[initFct]()})});