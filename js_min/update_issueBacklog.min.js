var g_ttForbidenStatusList,g_currentStatus;function getUpdateBacklogData(e,t,a,r,i){var d=jQuery("#formGetUpdateBacklogData");d.find("input[name=bugid]").val(e),d.find("input[name=userid]").val(t),d.find("input[name=trackJobid]").val(a),d.find("input[name=trackDuration]").val(r),d.find("input[name=trackDate]").val(i);var u=jQuery.Deferred();return jQuery.ajax({type:d.attr("method"),dataType:"json",url:d.attr("action"),data:d.serialize(),success:function(e){null===e?(console.error("getUpdateBacklogData SUCCESS but data = null"),alert("ERROR: Action canceled, could not retrieve Task info."),u.reject()):u.resolve(e)},error:function(e){console.error("getUpdateBacklogData ERROR ",e),alert("ERROR: Action canceled, could not retrieve Task info."),u.reject()}}),u}function openUpdateBacklogDialogbox(e){var t=e,a=jQuery("#formUpdateBacklog");jQuery("#backlog").val(t.calculatedBacklog),jQuery("#divBacklogDialog").find(".issue_summary").text(t.summary),jQuery("#desc_effortEstim").text(t.effortEstim),jQuery("#desc_elapsed").text(t.elapsed),jQuery("#desc_currentBacklog").text(t.currentBacklog),jQuery("#desc_drift").text(t.drift),jQuery("#desc_trackDate").text("(on "+t.trackDate+")"),t.hasOwnProperty("deadline")?(jQuery("#desc_deadline").text(t.deadline),jQuery("#th_deadline").show(),jQuery("#desc_deadline").show()):(jQuery("#th_deadline").hide(),jQuery("#desc_deadline").hide()),jQuery("#desc_drift").css("backgroundColor","#"+t.driftColor),a.find("input[name=year]").val(jQuery("#year").val()),a.find("input[name=bugid]").val(t.bugid),a.find("input[name=statusid]").val(t.currentStatus),a.find("input[name=trackJobid]").val(t.trackJobid),a.find("input[name=trackUserid]").val(t.trackUserid),a.find("input[name=trackDate]").val(t.trackDate),a.find("input[name=bugResolvedStatusThreshold]").val(t.bugResolvedStatusThreshold),a.find("input[name=bugStatusNew]").val(t.bugStatusNew),a.find("input[name=statusNameNew]").val(t.availableStatusList[t.bugStatusNew]),jQuery(".formUpdateBacklog_errorMsg").text("");e=issueBacklogSmartyData.i18n_Task+" "+t.dialogBoxTitle+" - "+issueBacklogSmartyData.i18n_UpdateBacklog;jQuery("#divBacklogDialog").dialog("option","title",e),jQuery("#status").empty();var r,i=t.availableStatusList;for(r in i)i.hasOwnProperty(r)&&(r==t.currentStatus?jQuery("#status").append(jQuery("<option>").attr("id",r).attr("selected","selected").append(i[r])):jQuery("#status").append(jQuery("<option>").attr("id",r).append(i[r])));if(g_ttForbidenStatusList=t.ttForbidenStatusList,g_currentStatus=t.currentStatus,jQuery("#handlerid").empty(),t.trackUserid!=t.handlerId&&jQuery("#handlerid").append(jQuery("<option>").attr("id",t.trackUserid).attr("value",t.trackUserid).append(t.trackUserName)),jQuery("#handlerid").append(jQuery("<option>").attr("id",t.handlerId).attr("value",t.handlerId).attr("selected","selected").append(t.handlerName)),0==t.handlerId&&(console.log("handlerId 0"),$("#handlerid").val(t.trackUserid)),jQuery("#timeToAdd").empty(),0==t.trackDuration)$("#tr_timeToAdd").hide(),$("#tr_handlerid").hide(),$("#tr_status").hide(),$("#pTimetrackNote").hide(),a.find("input[name=action]").val("updateBacklog");else for(r in $("#tr_timeToAdd").show(),$("#tr_handlerid").show(),$("#tr_status").show(),$("#pTimetrackNote").show(),a.find("input[name=action]").val("addTimetrack"),i=t.availableDurationList)i.hasOwnProperty(r)&&(r==t.trackDuration?jQuery("#timeToAdd").append(jQuery("<option>").attr("id",r).attr("value",r).attr("selected","selected").append(i[r])):jQuery("#timeToAdd").append(jQuery("<option>").attr("id",r).attr("value",r).append(i[r])));jQuery("#divBacklogDialog").dialog("open")}function changeBackLogValue(e){var t=jQuery("#bugResolvedStatusThreshold").val(),a=jQuery("#status").children(":selected").attr("id");t<=a&&$("#backlog").val("0"),a<t&&t<=e&&$("#backlog").val("")}function updateTips(e){$("#formUpdateBacklog_validateTips").text(e)}function checkRegexp(e,t,a,r){return!(!r||""!=$.trim(e.val()))||(!!t.test(e.val())||(e.addClass("ui-state-error"),updateTips(a),!1))}function checkStatus(e,t,a,r,i){if(t<a&&0==e.val())return e.addClass("ui-state-error"),updateTips(issueBacklogSmartyData.i18n_TaskNotResolved),!1;if(t==r&&0<e.val())return e.addClass("ui-state-error"),updateTips(issueBacklogSmartyData.i18n_StatusCantBe+i),!1;if(a<=t&&0!=e.val())return e.addClass("ui-state-error"),updateTips(issueBacklogSmartyData.i18n_TaskResolved),!1;if(void 0===g_ttForbidenStatusList[g_currentStatus])return!0;e.addClass("ui-state-error");var d,u="";for(d in g_ttForbidenStatusList)u+=g_ttForbidenStatusList[d]+", ";return updateTips(issueBacklogSmartyData.i18n_wrongStatus+u),!1}function isBacklogDialogFieldsValid(){var e=!0;updateTips(""),jQuery("#backlog").removeClass("ui-state-error"),e=e&&checkRegexp(jQuery("#backlog"),/^[0-9]+(\.[0-9][0-9]?5?)?$/i,"format:  '1',  '0.3'  or  '2.55' or '2.125'",!1);var t=jQuery("#bugResolvedStatusThreshold").val(),a=jQuery("#bugStatusNew").val(),r=jQuery("#statusNameNew").val(),i=jQuery("#status").children(":selected").attr("id"),e=e&&checkStatus(jQuery("#backlog"),i,t,a,r);return issueBacklogSmartyData.isTrackNoteMandatory&&!$("#pTimetrackNote").is(":hidden")&&(r=jQuery("#issue_note"),e&&""===r.val()&&(updateTips(issueBacklogSmartyData.i18n_ttNoteRequired),r.addClass("ui-state-error"),e=!1)),e}jQuery(document).ready(function(){jQuery("#status").on("focus",function(){previousStatus=jQuery("#status").children(":selected").attr("id")}).change(function(){jQuery("#status").blur(),changeBackLogValue(previousStatus);var e=jQuery("#status").children(":selected").attr("id");jQuery("#formUpdateBacklog").find("input[name=statusid]").val(e)});var e=jQuery("#backlog"),t=jQuery("#issue_note"),a=$([]).add(e),a=$([]).add(t);jQuery("#divBacklogDialog").dialog({autoOpen:!1,height:"auto",width:500,modal:!0,open:function(){jQuery("#backlog").select(),changeBackLogValue(0)},buttons:{Ok:function(){var e;isBacklogDialogFieldsValid()&&(e=jQuery("#formUpdateBacklog"),jQuery.ajax({type:"POST",url:timetrackingSmartyData.ajaxPage,data:e.serialize(),dataType:"json",success:function(e){var t;"SUCCESS"===e.statusMsg?e.hasOwnProperty("weekTaskDetailsHtml")?(jQuery("#weekTaskDetailsDiv").html(jQuery.trim(e.weekTaskDetailsHtml)),updateWidgets("#weekTaskDetailsDiv"),jQuery("#divBacklogDialog").dialog("close")):((t=jQuery("#formReloadTimetrackingPage")).find("input[name=bugid]").val(e.bugid),t.find("input[name=date]").val(e.date),t.find("input[name=weekid]").val(e.weekid),t.submit()):(console.error(e.statusMsg),jQuery(".formUpdateBacklog_errorMsg").text(e.statusMsg))},error:function(e,t,a){console.error(t,a),jQuery(".formUpdateBacklog_errorMsg").text("ERROR: Please contact your CodevTT administrator")}}))},Cancel:function(){jQuery(this).dialog("close")}},close:function(){a.val("").removeClass("ui-state-error"),a.css("backgroundColor","transparent"),updateTips(""),issueBacklogSmartyData.isTrackNoteDisplayed&&$(".issue_note").val("")}}),$("#divBacklogDialog").keydown(function(e){if(e.keyCode==jQuery.ui.keyCode.ENTER)return $(this).parent().find("button:eq(0)").trigger("click"),!1}),jQuery(".js-updateBacklog-link").click(function(e){e.preventDefault(),getUpdateBacklogData(this.getAttribute("data-bugId"),issueBacklogSmartyData.userid).done(function(e){"BacklogUpdateNotNeeded"===e.diagnostic?console.log("BacklogUpdateNotNeeded"):openUpdateBacklogDialogbox(e)})})});