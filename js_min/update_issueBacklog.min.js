var g_ttForbidenStatusList,g_currentStatus;function getUpdateBacklogData(e,a,t,r,i){var d=jQuery("#formGetUpdateBacklogData");d.find("input[name=bugid]").val(e),d.find("input[name=userid]").val(a),d.find("input[name=trackJobid]").val(t),d.find("input[name=trackDuration]").val(r),d.find("input[name=trackDate]").val(i);var s=jQuery.Deferred();return jQuery.ajax({type:d.attr("method"),dataType:"json",url:d.attr("action"),data:d.serialize(),success:function(e){null===e?(console.error("getUpdateBacklogData SUCCESS but data = null"),alert("ERROR: Action canceled, could not retrieve Task info."),s.reject()):s.resolve(e)},error:function(e){console.error("getUpdateBacklogData ERROR ",e),alert("ERROR: Action canceled, could not retrieve Task info."),s.reject()}}),s}function openUpdateBacklogDialogbox(e){var a=e,t=jQuery("#formUpdateBacklog");jQuery("#backlog").val(a.calculatedBacklog),jQuery("#divBacklogDialog").find(".issue_summary").text(a.summary),jQuery("#desc_effortEstim").text(a.effortEstim),jQuery("#desc_elapsed").text(a.elapsed),jQuery("#desc_currentBacklog").text(a.currentBacklog),jQuery("#desc_drift").text(a.drift),jQuery("#desc_trackDate").text("(on "+a.trackDate+")"),a.hasOwnProperty("deadline")?(jQuery("#desc_deadline").text(a.deadline),jQuery("#th_deadline").show(),jQuery("#desc_deadline").show()):(jQuery("#th_deadline").hide(),jQuery("#desc_deadline").hide()),jQuery("#desc_drift").css("backgroundColor","#"+a.driftColor),t.find("input[name=year]").val(jQuery("#year").val()),t.find("input[name=bugid]").val(a.bugid),t.find("input[name=statusid]").val(a.currentStatus),t.find("input[name=trackJobid]").val(a.trackJobid),t.find("input[name=trackUserid]").val(a.trackUserid),t.find("input[name=trackDate]").val(a.trackDate),t.find("input[name=bugResolvedStatusThreshold]").val(a.bugResolvedStatusThreshold),t.find("input[name=bugStatusNew]").val(a.bugStatusNew),t.find("input[name=statusNameNew]").val(a.availableStatusList[a.bugStatusNew]),jQuery(".formUpdateBacklog_errorMsg").text("");e=issueBacklogSmartyData.i18n_Task+" "+a.dialogBoxTitle+" - "+issueBacklogSmartyData.i18n_UpdateBacklog;jQuery("#divBacklogDialog").dialog("option","title",e),jQuery("#status").empty();var r,i=a.availableStatusList;for(r in i)i.hasOwnProperty(r)&&(r==a.currentStatus?jQuery("#status").append(jQuery("<option>").attr("id",r).attr("selected","selected").append(i[r])):jQuery("#status").append(jQuery("<option>").attr("id",r).append(i[r])));if(g_ttForbidenStatusList=a.ttForbidenStatusList,g_currentStatus=a.currentStatus,jQuery("#handlerid").empty(),a.trackUserid!=a.handlerId&&jQuery("#handlerid").append(jQuery("<option>").attr("id",a.trackUserid).attr("value",a.trackUserid).append(a.trackUserName)),jQuery("#handlerid").append(jQuery("<option>").attr("id",a.handlerId).attr("value",a.handlerId).attr("selected","selected").append(a.handlerName)),0==a.handlerId&&(console.log("handlerId 0"),$("#handlerid").val(a.trackUserid)),jQuery("#timeToAdd").empty(),0==a.trackDuration)$("#tr_timeToAdd").hide(),$("#tr_handlerid").hide(),$("#tr_status").hide(),$("#pTimetrackNote").hide(),t.find("input[name=action]").val("updateBacklog");else for(r in $("#tr_timeToAdd").show(),$("#tr_handlerid").show(),$("#tr_status").show(),$("#pTimetrackNote").show(),t.find("input[name=action]").val("addTimetrack"),i=a.availableDurationList)i.hasOwnProperty(r)&&(r==a.trackDuration?jQuery("#timeToAdd").append(jQuery("<option>").attr("id",r).attr("value",r).attr("selected","selected").append(i[r])):jQuery("#timeToAdd").append(jQuery("<option>").attr("id",r).attr("value",r).append(i[r])));jQuery("#divBacklogDialog").dialog("open")}function changeBackLogValue(e){var a=jQuery("#bugResolvedStatusThreshold").val(),t=jQuery("#status").children(":selected").attr("id");a<=t&&$("#backlog").val("0"),t<a&&a<=e&&$("#backlog").val("")}function updateTips(e){$("#formUpdateBacklog_validateTips").text(e)}function checkRegexp(e,a,t,r){return!(!r||""!=$.trim(e.val()))||(!!a.test(e.val())||(e.addClass("ui-state-error"),updateTips(t),!1))}function checkStatus(e,a,t,r,i){if(a<t&&0==e.val())return e.addClass("ui-state-error"),updateTips(issueBacklogSmartyData.i18n_TaskNotResolved),!1;if(a==r&&0<e.val())return e.addClass("ui-state-error"),updateTips(issueBacklogSmartyData.i18n_StatusCantBe+i),!1;if(t<=a&&0!=e.val())return e.addClass("ui-state-error"),updateTips(issueBacklogSmartyData.i18n_TaskResolved),!1;if(void 0===g_ttForbidenStatusList[g_currentStatus])return!0;e.addClass("ui-state-error");var d,s="";for(d in g_ttForbidenStatusList)s+=g_ttForbidenStatusList[d]+", ";return updateTips(issueBacklogSmartyData.i18n_wrongStatus+s),!1}function isBacklogDialogFieldsValid(){var e=!0;updateTips(""),jQuery("#backlog").removeClass("ui-state-error"),e=e&&checkRegexp(jQuery("#backlog"),/^[0-9]+(\.[0-9][0-9]?5?)?$/i,"format:  '1',  '0.3'  or  '2.55' or '2.125'",!1);var a=jQuery("#bugResolvedStatusThreshold").val(),t=jQuery("#bugStatusNew").val(),r=jQuery("#statusNameNew").val(),i=jQuery("#status").children(":selected").attr("id"),e=e&&checkStatus(jQuery("#backlog"),i,a,t,r);return issueBacklogSmartyData.isTrackNoteMandatory&&!$("#pTimetrackNote").is(":hidden")&&(r=jQuery("#issue_note"),e&&""===r.val()&&(updateTips(issueBacklogSmartyData.i18n_ttNoteRequired),r.addClass("ui-state-error"),e=!1)),e}jQuery(document).ready(function(){jQuery("#status").on("focus",function(){previousStatus=jQuery("#status").children(":selected").attr("id")}).change(function(){jQuery("#status").blur(),changeBackLogValue(previousStatus);var e=jQuery("#status").children(":selected").attr("id");jQuery("#formUpdateBacklog").find("input[name=statusid]").val(e)});var e=jQuery("#backlog"),a=jQuery("#issue_note"),t=$([]).add(e),t=$([]).add(a);jQuery("#divBacklogDialog").dialog({autoOpen:!1,height:"auto",width:500,modal:!0,open:function(){jQuery("#backlog").select(),changeBackLogValue(0)},buttons:{Ok:function(){var e;isBacklogDialogFieldsValid()&&(e=jQuery("#formUpdateBacklog"),jQuery.ajax({type:"POST",url:timetrackingSmartyData.ajaxPage,data:e.serialize(),dataType:"json",success:function(e){var a;"SUCCESS"===e.statusMsg?e.hasOwnProperty("weekTaskDetailsHtml")?(jQuery("#weekTaskDetailsDiv").html(jQuery.trim(e.weekTaskDetailsHtml)),updateWidgets("#weekTaskDetailsDiv"),jQuery("#divBacklogDialog").dialog("close")):((a=jQuery("#formReloadTimetrackingPage")).find("input[name=bugid]").val(e.bugid),a.find("input[name=date]").val(e.date),a.find("input[name=weekid]").val(e.weekid),a.submit()):(console.error(e.statusMsg),jQuery(".formUpdateBacklog_errorMsg").text(e.statusMsg))},error:function(e,a,t){console.error(a,t),jQuery(".formUpdateBacklog_errorMsg").text("ERROR: Please contact your CodevTT administrator")}}))},Cancel:function(){jQuery(this).dialog("close")}},close:function(){t.val("").removeClass("ui-state-error"),t.css("backgroundColor","transparent"),updateTips(""),issueBacklogSmartyData.isTrackNoteDisplayed&&$(".issue_note").val("")}}),jQuery(".js-updateBacklog-link").click(function(e){e.preventDefault(),getUpdateBacklogData(this.getAttribute("data-bugId"),issueBacklogSmartyData.userid).done(function(e){"BacklogUpdateNotNeeded"===e.diagnostic?console.log("BacklogUpdateNotNeeded"):openUpdateBacklogDialogbox(e)})})});