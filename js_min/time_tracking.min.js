function updateJobList(availableJobs){var jobSelect=jQuery("#job");jobSelect.empty();var nbJobs=0;for(var k in availableJobs){if(availableJobs.hasOwnProperty(k)){nbJobs++}}if(nbJobs>1){jobSelect.append(jQuery("<option>").attr("value","0").append("").attr("selected","selected"))}for(var id in availableJobs){if(availableJobs.hasOwnProperty(id)){jobSelect.append(jQuery("<option>").attr("value",id).append(availableJobs[id]))}}}function getJobsAndDurations(event){event.preventDefault();var bValid=true;if(bValid){jQuery("#loading").show();jQuery.ajax({url:timetrackingSmartyData.ajaxPage,type:"POST",dataType:"json",data:{action:"getJobsAndDurations",managedUserid:timetrackingSmartyData.userid,projectid:jQuery("#projectid").val(),bugid:jQuery("#bugid").val()},success:function(data){var availableJobs=data["availableJobs"];updateJobList(availableJobs);jQuery("#duree").empty();var availableDurationList=data["availableDurations"];for(var id in availableDurationList){if(availableDurationList.hasOwnProperty(id)){jQuery("#duree").append(jQuery("<option>").attr("value",id).append(availableDurationList[id]))}}jQuery("#loading").hide()},error:function(jqXHR,textStatus,errorThrown){jQuery("#loading").hide();console.error(textStatus,errorThrown);alert("ERROR: Please contact your CodevTT administrator")}})}}function addTimetrackAndReload(ttNote){var form1=jQuery("#form1");var bugid=jQuery("#bugid").val();var trackJobid=form1.find("select[name=trackJobid]").val();var timeToAdd=form1.find("select[name=timeToAdd]").val();var trackDate=jQuery("#datepicker").val();jQuery.ajax({type:"POST",url:timetrackingSmartyData.ajaxPage,data:{action:"addTimetrack",bugid:bugid,trackDate:trackDate,trackJobid:trackJobid,trackUserid:timetrackingSmartyData.userid,timeToAdd:timeToAdd,issue_note:ttNote},dataType:"json",success:function(data){if("SUCCESS"===data.statusMsg){var formReloadPage=jQuery("#formReloadTimetrackingPage");formReloadPage.find("input[name=bugid]").val(bugid);formReloadPage.find("input[name=date]").val(trackDate);formReloadPage.find("input[name=weekid]").val(timetrackingSmartyData.weekid);formReloadPage.submit()}},error:function(jqXHR,textStatus,errorThrown){console.error(textStatus,errorThrown);alert("ERROR: Please contact your CodevTT administrator")}})}jQuery(document).ready(function(){if(timetrackingSmartyData.datepickerLocale!="en"){jQuery.datepicker.setDefaults($.datepicker.regional[timetrackingSmartyData.datepickerLocale])}jQuery("#datepicker").datepicker("setDate",timetrackingSmartyData.datepickerDate);jQuery("#projectid").change(function(event){getJobsAndDurations(event)});jQuery("#bugid").change(function(){getJobsAndDurations(event)});jQuery("#filters").click(function(event){event.preventDefault();jQuery("#setfilter_dialog_form").dialog("open")});jQuery("#bugid").select2({placeholder:timetrackingSmartyData.i18n_TypeToSearch,minimumInputLength:3,width:"resolve",ajax:{type:"POST",url:timetrackingSmartyData.ajaxPage,dataType:"json",delay:500,data:function(params){var query={action:"searchIssues",search:params.term,projectId:jQuery("#projectid").val(),managedUserid:timetrackingSmartyData.userid};return query},processResults:function(data,page){return{results:data}}}});if("0"!==timetrackingSmartyData.defaultBugid){var option=new Option(timetrackingSmartyData.defaultBugText,timetrackingSmartyData.defaultBugid,true,true);jQuery("#bugid").append(option)}jQuery("#btAddTrack").click(function(){var foundError=0;var msgString=timetrackingSmartyData.i18n_someFieldsAreMissing+"\n\n";var form1=jQuery("#form1");var bugid=jQuery("#bugid").val();var jobid=form1.find("select[name=trackJobid]").val();var trackDuration=form1.find("select[name=timeToAdd]").val();if("0"===bugid||""===bugid){msgString+=timetrackingSmartyData.i18n_task+"\n";++foundError}if("0"===jobid||""===jobid){msgString+=timetrackingSmartyData.i18n_job+"\n";++foundError}if("0"===trackDuration||""===trackDuration){msgString+=timetrackingSmartyData.i18n_duration+"\n";++foundError}if(0===foundError){var trackDate=jQuery("#datepicker").val();var deferred=getUpdateBacklogData(bugid,timetrackingSmartyData.userid,jobid,trackDuration,trackDate);deferred.done(function(updateBacklogJsonData){if("TimetrackingForbidden"===updateBacklogJsonData["diagnostic"]){alert(updateBacklogJsonData["reasonWhy"])}else if("BacklogUpdateNotNeeded"===updateBacklogJsonData["diagnostic"]){addTimetrackAndReload("")}else if("timetrackNoteOnly"===updateBacklogJsonData["diagnostic"]){jQuery("#setTimetrackNoteDlg_taskSummary").text(jQuery("#bugid option:selected").text());jQuery("#setTimetrackNoteDlg_duration").text(jQuery("#duree option:selected").text());jQuery("#setTimetrackNoteDlg_job").text(jQuery("#job option:selected").text());jQuery("#setTimetrackNoteDlg_date").text(jQuery("#datepicker").val());jQuery("#setTimetrackNoteDlg").dialog("open")}else{jQuery("#formUpdateBacklog").off("submit");openUpdateBacklogDialogbox(updateBacklogJsonData)}})}else{alert(msgString)}});jQuery("#setTimetrackNoteDlg").dialog({autoOpen:false,resizable:true,height:"auto",width:400,modal:true,buttons:[{text:timetrackingSmartyData.i18n_Ok,click:function(){var ttNote=jQuery("#setTimetrackNoteDlg_timetrackNote").val();addTimetrackAndReload(ttNote)}},{text:timetrackingSmartyData.i18n_Cancel,click:function(){jQuery(this).dialog("close")}}]});jQuery("#setfilter_dialog_form").dialog({autoOpen:false,height:"auto",width:500,modal:true,buttons:{Ok:function(){var form=jQuery("#formSetFilters");form.find("input[name=projectid]").val(jQuery("#projectid").val());form.find("input[name=bugid]").val(jQuery("#bugid").val());form.find("input[name=job]").val(jQuery("#job").val());form.find("input[name=duree]").val(jQuery("#duree").val());form.find("input[name=weekid]").val(jQuery("#weekid").val());form.find("input[name=year]").val(jQuery("#year").val());form.submit()},Cancel:function(){jQuery(this).dialog("close")}}});var formUpdateWeek=jQuery("#formUpdateWeek");function updateFormWeek(){formUpdateWeek.find("input[name=projectid]").val(jQuery("#projectid").val());formUpdateWeek.find("input[name=bugid]").val(jQuery("#bugid").val());formUpdateWeek.find("input[name=job]").val(jQuery("#job").val());formUpdateWeek.find("input[name=duree]").val(jQuery("#duree").val())}jQuery("#previousweek").click(function(){updateFormWeek();var weekid=jQuery("#weekid").val();if(1!=weekid){formUpdateWeek.find("select[name=weekid]").val(--weekid)}else{var year=jQuery("#year").val();var prevYear=+year-+1;var lastWeekPrevYear=timetrackingSmartyData.nbWeeksPrevYear;formUpdateWeek.find("select[name=weekid]").val(lastWeekPrevYear);formUpdateWeek.find("select[name=year]").val(prevYear)}var trackDate=jQuery("#datepicker").val();formUpdateWeek.find("input[name=date]").val(trackDate);formUpdateWeek.submit()});jQuery("#nextweek").click(function(){updateFormWeek();var weekid=jQuery("#weekid").val();if(parseInt(weekid)<parseInt(timetrackingSmartyData.nbWeeksThisYear)){formUpdateWeek.find("select[name=weekid]").val(++weekid)}else{var year=jQuery("#year").val();var nextYear=+year+ +1;formUpdateWeek.find("select[name=weekid]").val(1);formUpdateWeek.find("select[name=year]").val(nextYear)}var trackDate=jQuery("#datepicker").val();formUpdateWeek.find("input[name=date]").val(trackDate);formUpdateWeek.submit()});jQuery("#weekid, #year").change(function(){updateFormWeek();formUpdateWeek.submit()});jQuery(".deleteWeekTimetrack_link").click(function(e){e.preventDefault();var timetrackId=$(this).parents(".weekTimetrack").attr("data-weekTimetrackId");jQuery.ajax({type:"POST",url:timetrackingSmartyData.ajaxPage,data:{action:"getDeleteTimetrackData",timetrackId:timetrackId},dataType:"json",success:function(data){if("SUCCESS"===data.statusMsg){jQuery(".issue_summary").text(data.issueSummary);jQuery("#desc_date").text(data.date);jQuery("#desc_id").text(data.formatedId);jQuery("#desc_duration").text(data.duration);jQuery("#desc_job").text(data.jobName);jQuery("#formDeleteTrack").find("input[name=trackid]").val(timetrackId);jQuery("#backlogChangeInfo").text("");if(data.isRecreditBacklog){jQuery("#backlogChangeInfo").text("(Backlog will change to : "+data.futureBacklog+")")}}},error:function(jqXHR,textStatus,errorThrown){console.error(textStatus,errorThrown);alert("ERROR: Please contact your CodevTT administrator")}});jQuery("#deleteTrack_dialog_form").dialog("open")});jQuery("#deleteTrack_dialog_form").dialog({autoOpen:false,resizable:true,height:"auto",width:400,modal:true,buttons:[{text:timetrackingSmartyData.i18n_Delete,click:function(){var formDeleteTrack=$("#formDeleteTrack");$.ajax({url:timetrackingSmartyData.ajaxPage,type:"POST",dataType:"json",data:formDeleteTrack.serialize(),success:function(data){if("SUCCESS"===data.statusMsg){var formReloadPage=jQuery("#formReloadTimetrackingPage");formReloadPage.find("input[name=bugid]").val(data.bugid);formReloadPage.find("input[name=date]").val(data.trackDate);formReloadPage.submit()}else{console.error("Ajax statusMsg",data.statusMsg);alert(data.statusMsg)}},error:function(jqXHR,textStatus,errorThrown){console.error(textStatus,errorThrown);alert("ERROR: Please contact your CodevTT administrator")}});jQuery(this).dialog("close")}},{text:timetrackingSmartyData.i18n_Cancel,click:function(){jQuery(this).dialog("close")}}]});jQuery(".editWeekTimetrack_link").click(function(e){e.preventDefault();var timetrackId=$(this).parents(".weekTimetrack").attr("data-weekTimetrackId");jQuery.ajax({type:"POST",url:timetrackingSmartyData.ajaxPage,data:{action:"getEditTimetrackData",timetrackId:timetrackId},dataType:"json",success:function(data){if("SUCCESS"===data.statusMsg){$("#timeToEdit").empty();var availableDurationList=data.durationsList;for(var id in availableDurationList){if(availableDurationList.hasOwnProperty(id)){$("#timeToEdit").append($("<option>").attr("value",id).append(availableDurationList[id]))}}$("#editJob").empty();var availableJobs=data.availableJobs;for(var id in availableJobs){if(availableJobs.hasOwnProperty(id)){$("#editJob").append($("<option>").attr("value",id).append(availableJobs[id]))}}$("#timetrackId").val(timetrackId);$("#timeToEdit").val(data.duration);$("#backlogToEdit").val(data.backlog);$("#editJob").val(data.jobid);$("#issue_note_edit").val(data.note);$("#taskSummary").text(data.issueSummary);$("#datepickerEditer").datepicker("setDate",data.date);var myTr=$("#weekTimetrackingTuples .weekTimetrack[data-weekTimetrackId^="+timetrackId+"]");myTr.attr("data-weekTimetrackBacklog",data.backlog);myTr.attr("data-weekTimetrackDuration",data.duration);myTr.attr("data-weekTimetrackIsRecreditBacklog",data.isRecreditBacklog);var editWeekTimetrack_dialog=$("#editWeekTimetrack_dialog");var backlogChangeInfo=editWeekTimetrack_dialog.find("#backlogChangeInfo");backlogChangeInfo.text("");editWeekTimetrack_dialog.dialog("open")}else{console.error("Ajax statusMsg",data.statusMsg);alert(data.statusMsg)}},error:function(jqXHR,textStatus,errorThrown){console.error(textStatus,errorThrown);alert("ERROR: Please contact your CodevTT administrator")}})});$("#timeToEdit").change(function(){var editWeekTimetrackDialog=$("#editWeekTimetrack_dialog");var backlogChangeInfo=editWeekTimetrackDialog.find("#backlogChangeInfo");var timetrackId=editWeekTimetrackDialog.find("#timetrackId").val();var newDuration=parseFloat(editWeekTimetrackDialog.find("#timeToEdit").val());var myTr=$("#weekTimetrackingTuples .weekTimetrack[data-weekTimetrackId^="+timetrackId+"]");var oldDuration=parseFloat(myTr.attr("data-weekTimetrackDuration"));var backlog=parseFloat(myTr.attr("data-weekTimetrackBacklog"));var isRecreditBacklog=myTr.attr("data-weekTimetrackIsRecreditBacklog");if(isRecreditBacklog==="true"){if(newDuration!==oldDuration){var futureBacklog=backlog+oldDuration-newDuration;backlogChangeInfo.text("(Backlog will change to : "+futureBacklog+")")}else{backlogChangeInfo.text("")}}});$("#editWeekTimetrack_dialog").dialog({autoOpen:false,height:"auto",width:500,modal:true,buttons:{Ok:function(){var note=$("#issue_note_edit").val();var date=$("#datepickerEditer").val();var duration=$("#timeToEdit").val();var jobid=$("#editJob").val();var timetrackId=$("#timetrackId").val();var backlog=$("#backlogToEdit").val();$.ajax({url:timetrackingSmartyData.ajaxPage,type:"POST",dataType:"json",data:{action:"updateTimetrack",timetrackId:timetrackId,note:note,date:date,duration:duration,jobid:jobid,userid:timetrackingSmartyData.userid,weekid:timetrackingSmartyData.weekid,year:timetrackingSmartyData.year},success:function(data){if("SUCCESS"===data.statusMsg){var myTr=$("#weekTimetrackingTuples .weekTimetrack[data-weekTimetrackId^="+timetrackId+"]");myTr.find(".weekTimetrack_duration").text(duration);myTr.find(".weekTimetrack_date").text(data.cosmeticDate);myTr.find(".weekTimetrack_jobName").text(data.jobName);myTr.find(".weekTimetrack_ttNote").html(data.ttNote);jQuery("#weekTaskDetailsDiv").html(jQuery.trim(data.timesheetHtml));updateWidgets("#weekTaskDetailsDiv")}else{console.error("Ajax statusMsg",data.statusMsg);alert(data.statusMsg)}},error:function(jqXHR,textStatus,errorThrown){console.error(textStatus,errorThrown);alert("ERROR: Please contact your CodevTT administrator")}});jQuery(this).dialog("close")},Cancel:function(){jQuery(this).dialog("close")}}})});
