jQuery(document).ready(function(){if(smartyDataCmdEdit.datepickerLocale!=="en"){jQuery.datepicker.setDefaults($.datepicker.regional[smartyDataCmdEdit.datepickerLocale])}if(""!==smartyDataCmdEdit.cmdStartDate){jQuery("#cmdStartDate").datepicker("setDate",smartyDataCmdEdit.cmdStartDate)}else{jQuery("#cmdStartDate").datepicker()}if(""!==smartyDataCmdEdit.cmdDeadline){jQuery("#cmdDeadline").datepicker("setDate",smartyDataCmdEdit.cmdDeadline)}else{jQuery("#cmdDeadline").datepicker()}jQuery("#cmdStartDate").datepicker("option","beforeShow",function(input){jQuery(this).datepicker("option","maxDate",jQuery("#cmdDeadline").datepicker("getDate"))});jQuery("#cmdDeadline").datepicker("option","beforeShow",function(input){jQuery(this).datepicker("option","minDate",jQuery("#cmdStartDate").datepicker("getDate"))});jQuery("#btSaveCommand").click(function(){var foundError=0;var msgString="";var form=jQuery("#updateCmdInfoForm");if(0==form.find("input[name=cmdName]").val().length){msgString+=smartyDataCmdEdit.i18n_missingFieldCmdName+"\n";++foundError}if(""!=form.find("input[name=cmdTotalSoldDays]").val()){bValid=checkRegexp(form.find("input[name=cmdTotalSoldDays]"),/^[0-9]+(\.[0-9]+)?$/i,"format: '1234' or '123.35'");if(!bValid){msgString+=smartyDataCmdEdit.i18n_nanSoldCharge+"\n";++foundError}}if(0===foundError){if(""!==smartyDataCmdEdit.cmdId){var deferred=saveTree();deferred.done(function(){form.submit()});deferred.fail(function(){$("#tree").fancytree("destroy");initTree()})}else{form.submit()}}else{alert(msgString)}});if(""!==smartyDataCmdEdit.cmdId){jQuery("#btDeleteCommand").click(function(event){jQuery("#deleteCommand_dialog_form").dialog("open")})}jQuery("#btAddCmdIssue").click(function(event){addCmdIssue()});jQuery("#bugid").keypress(function(event){if(jQuery.ui.keyCode.ENTER==event.keyCode){addCmdIssue();event.preventDefault()}});jQuery.ajax({url:"js_min/datatable.min.js",dataType:"script",cache:true});jQuery("#deleteCommand_dialog_form").dialog({autoOpen:false,resizable:true,width:"auto",modal:true,buttons:[{text:smartyDataCmdEdit.i18n_delete,click:function(){jQuery("#formDeleteCommand").submit()}},{text:smartyDataCmdEdit.i18n_cancel,click:function(){jQuery(this).dialog("close")}}]});jQuery("#removeCmdIssue_dialog_form").dialog({autoOpen:false,resizable:true,width:"auto",modal:true,buttons:[{text:smartyDataCmdEdit.i18n_remove,click:function(){jQuery("#formRemoveCmdIssue").submit()}},{text:smartyDataCmdEdit.i18n_cancel,click:function(){jQuery(this).dialog("close")}}]});jQuery("#removeCmdSet_dialog_form").dialog({autoOpen:false,resizable:true,width:"auto",modal:true,buttons:[{text:smartyDataCmdEdit.i18n_remove,click:function(){jQuery("#formRemoveCmdSet").submit()}},{text:smartyDataCmdEdit.i18n_cancel,click:function(){jQuery(this).dialog("close")}}]});jQuery("#provisionsTable").on("click",".deleteProvision_link",function(e){e.preventDefault();var trProv=$(this).parents(".provRow");var rowId=$(trProv).attr("data-provRowId");var provDate=$(trProv).children(".provDate").text();var provType=$(trProv).children(".provType").text();var provBudgetDays=$(trProv).children(".provBudgetDays").text();var provBudget=$(trProv).find(".provBudget").text();var provCurrency=$(trProv).find(".provCurrency").text();var provSummary=$(trProv).children(".provSummary").text();var confirmString=smartyDataCmdEdit.i18n_confirmDeleteProvision+"\n\n"+provDate+" "+provType+"\n"+provBudgetDays+" "+smartyDataCmdEdit.i18n_days+"\n"+provBudget+" "+provCurrency+"\n\n"+provSummary;if(confirm(confirmString)){$.ajax({url:smartyDataCmdEdit.ajaxPage,type:"POST",dataType:"json",data:{action:"deleteProvision",cmdId:smartyDataCmdEdit.cmdId,provRowId:rowId},success:function(data){if(null===data){console.error("ERROR deleteProvision: no data");alert("ERROR: Please contact your CodevTT administrator")}else{if("SUCCESS"!==data.statusMsg){console.error("ERROR Ajax statusMsg",data.statusMsg);alert(data.statusMsg)}else{jQuery(".provRow[data-provRowId='"+data.rowId+"']").remove()}}},error:function(jqXHR,textStatus,errorThrown){console.error("ERROR deleteProvision errorThrown",errorThrown)}})}});jQuery("#provisionsTable").on("click",".editProvision_link",function(e){var trProv=$(this).parents(".provRow");var rowId=$(trProv).attr("data-provRowId");var provDate=$(trProv).children(".provDate").text();var provTypeId=$(trProv).children(".provType").attr("data-provTypeId");var provBudgetDays=$(trProv).children(".provBudgetDays").text();var provBudget=$(trProv).find(".provBudget").text();var provCurrency=$(trProv).find(".provCurrency").text();var provSummary=$(trProv).children(".provSummary").text();var checked=$(trProv).find(".cbIsInCheckBudget").is(":checked");jQuery("#type").val(provTypeId);jQuery("#datepicker").val(provDate);jQuery("#budgetDays").val(provBudgetDays);jQuery("#budget").val(provBudget);jQuery("#provisionCurrency").val(provCurrency);jQuery("#provisionCurrencyDisplayed").html(provCurrency);jQuery("#summary").val(provSummary);jQuery("#cb_isInCheckBudget").prop("checked",checked);jQuery("#addProvRowId").val(rowId);jQuery("#averageDailyRate").val("");updateADR();var dialog=jQuery("#addProvision_dialog_form");dialog.dialog("option","title",smartyDataCmdEdit.i18n_editProvision);jQuery("#addProvDlgAction").val("editProvision");dialog.dialog("open")});jQuery("#btAddProvision").click(function(event){var dialog=jQuery("#addProvision_dialog_form");dialog.dialog("option","title",smartyDataCmdEdit.i18n_addProvision);jQuery("#addProvDlgAction").val("addProvision");jQuery("#addProvRowId").val(0);jQuery("#datepicker").val("");jQuery("#budgetDays").val("");jQuery("#budget").val("0");jQuery("#summary").val("");jQuery("#averageDailyRate").val("0");jQuery("#cb_isInCheckBudget").prop("checked",false);jQuery("#addProvision_errorMsg").text("");dialog.dialog("open")});jQuery("#addProvision_dialog_form").dialog({autoOpen:false,resizable:true,width:"auto",modal:true,buttons:[{text:"OK",click:function(){var isInCheckBudget=jQuery("#cb_isInCheckBudget").attr("checked")?1:0;var form=jQuery("#formAddProvision");form.find("input[name=isInCheckBudget]").val(isInCheckBudget);if("SUCCESS"===addProvisionConsistencyCheck()){jQuery.ajax({url:smartyDataCmdEdit.ajaxPage,type:"POST",dataType:"json",async:false,data:form.serialize(),success:function(data){if("SUCCESS"===data.statusMsg){prov=data.provData;if("editProvision"===data.action){var myTr=$(".provRow[data-provRowId="+prov.provId+"]");myTr.find(".provDate").text(prov.date);myTr.find(".provType").text(prov.type).attr("data-provTypeId",data.type_id);myTr.find(".provBudgetDays").text(prov.budget_days);myTr.find(".provBudget").text(prov.budget);myTr.find(".provCurrency").text(prov.currency);myTr.find(".provSummary").html(prov.summary);myTr.find(".cbIsInCheckBudget").prop("checked",prov.is_checked);myTr.css("background-color","#ccffcc")}else{var trObj=createProvisionTr(prov);trObj.css("background-color","#ffff99");trObj.prependTo("#provisionsTable tbody")}}else{console.error("Ajax statusMsg",data.statusMsg);alert(data.statusMsg)}},error:function(jqXHR,textStatus,errorThrown){if("Forbidden"===errorThrown){window.location=smartyDataCmdEdit.page}else{console.error(textStatus,errorThrown);alert("ERROR: Please contact your CodevTT administrator")}}});jQuery(this).dialog("close")}}},{text:smartyDataCmdEdit.i18n_cancel,click:function(){jQuery(this).dialog("close")}}]});var provCsvFile;jQuery("#fileInput").on("change",function(e){provCsvFile=e.target.files[0]});jQuery("#btImportProvision").click(function(event){var data=new FormData;data.append("uploaded_csv",provCsvFile);data.append("action","importProvisionCSV");data.append("cmdid",smartyDataCmdEdit.cmdId);jQuery.ajax({async:false,type:"POST",url:smartyDataCmdEdit.ajaxPage,data:data,processData:false,contentType:false,dataType:"json",success:function(data){if("SUCCESS"===data.statusMsg){provData=data.provData;jQuery.each(provData,function(key,prov){var trObj=createProvisionTr(prov);trObj.css("background-color","#ffff99");trObj.prependTo("#provisionsTable tbody")})}else{console.error("Ajax statusMsg",data.statusMsg);alert(data.statusMsg)}},error:function(jqXHR,textStatus,errorThrown){if("Forbidden"===errorThrown){window.location=smartyDataCmdEdit.page}else{console.error(textStatus,errorThrown);alert("ERROR: Please contact your CodevTT administrator")}}})});jQuery("#provisionCurrency").on("change",function(e){var newCur=jQuery("#provisionCurrency").val();jQuery("#provisionCurrencyDisplayed").html(newCur)});jQuery("#budgetDays").keyup(function(event){updateBudget()});jQuery("#averageDailyRate").keyup(function(event){updateBudget()});jQuery("#budget").keyup(function(event){updateADR()});jQuery("#type").change(function(){var checked=jQuery("#type").val()==smartyDataCmdEdit.cmdProvisionTypeMngt?false:true;jQuery("#cb_isInCheckBudget").prop("checked",checked)})});function checkRegexp(o,regexp,n){if(!regexp.test(o.val())){return false}else{return true}}function addCmdIssue(){var foundError=0;var msgString="";var bug_id=jQuery.trim(document.forms["addCmdIssueForm"].bugid.value);if(""!=bug_id){var reg=new RegExp("^[0-9]+$","i");if(!reg.test(bug_id)){msgString+=smartyDataCmdEdit.i18n_nanTaskId+"\n";++foundError}}else{msgString+=smartyDataCmdEdit.i18n_missingFieldTaskId+"\n";++foundError}if(0==foundError){document.forms["addCmdIssueForm"].submit()}else{alert(msgString)}}function removeCmdIssue(bugid,project,description){jQuery("#desc_id").text(bugid);jQuery("#desc_project").text(project);jQuery("#desc_summary").text(description);jQuery("#formRemoveCmdIssue").find("input[name=bugid]").val(bugid);jQuery("#removeCmdIssue_dialog_form").dialog("open")}function removeCmdSet(commandsetid,name){var dialog=jQuery("#removeCmdSet_dialog_form");dialog.find(".desc_id").text(commandsetid);dialog.find(".desc_name").text(name);dialog.find("#formRemoveCmdSet").find("input[name=commandsetid]").val(commandsetid);dialog.dialog("open")}var provData;function updateADR(){if(""!=jQuery("#budget").val()&&0!=jQuery("#budget").val()&&""!=jQuery("#budgetDays").val()&&0!=jQuery("#budgetDays").val()){var adr=parseFloat(jQuery("#budget").val())/parseFloat(jQuery("#budgetDays").val());jQuery("#averageDailyRate").val(adr.toFixed(2))}else{jQuery("#averageDailyRate").val(0)}}function updateBudget(){if(""!=jQuery("#averageDailyRate").val()&&0!=jQuery("#averageDailyRate").val()&&""!=jQuery("#budgetDays").val()&&0!=jQuery("#budgetDays").val()){var budget=parseFloat(jQuery("#budgetDays").val())*parseFloat(jQuery("#averageDailyRate").val());jQuery("#budget").val(budget.toFixed(2))}}function createProvisionTr(provData){var trObj=jQuery("<tr></tr>").addClass("provRow").attr("data-provRowId",provData.provId);var btDelete=jQuery('<img align="absmiddle" src="images/b_drop.png">').addClass("deleteProvision_link").addClass("pointer").prop("title",smartyDataCmdEdit.i18n_delete);var btEdit=jQuery('<img align="absmiddle" src="images/b_edit.png">').addClass("editProvision_link").addClass("pointer").prop("title",smartyDataCmdEdit.i18n_edit);var tdObjButtons=jQuery('<td style="width:38px;">').addClass("ui-state-error-text");tdObjButtons.append(btDelete).append(" ").append(btEdit);var spanBudget=jQuery("<span>").text(provData.budget).addClass("provBudget");var spanCurrency=jQuery("<span>").text(provData.currency).addClass("provCurrency");var tdObjBudget=jQuery('<td style="text-align: right;">');tdObjBudget.append(spanBudget).append(" ").append(spanCurrency);trObj.append(tdObjButtons);trObj.append(jQuery("<td>").text(provData.date).addClass("provDate"));trObj.append(jQuery("<td>").text(provData.type).addClass("provType"));trObj.append(jQuery("<td>").text(provData.budget_days).addClass("provBudgetDays"));trObj.append(tdObjBudget);trObj.append(jQuery("<td>").html(provData.summary).addClass("provSummary"));if(provData.is_checked){trObj.append(jQuery("<td>").html('<input type="checkbox" class="cbIsInCheckBudget" disabled="disabled" checked/>'))}else{trObj.append(jQuery("<td>").html('<input type="checkbox" class="cbIsInCheckBudget" disabled="disabled" />'))}if(provData.csvFileLine){trObj.attr("data-csvFileLine",provData.csvFileLine)}return trObj}function addProvisionConsistencyCheck(){jQuery("#addProvision_errorMsg").text("");var form=jQuery("#addProvision_dialog_form");var errMsg="";if(""===form.find("#datepicker").val()){errMsg+=smartyDataCmdEdit.i18n_date+", "}if(""===form.find("#budgetDays").val()){errMsg+=smartyDataCmdEdit.i18n_budgetDays+", "}if(""===errMsg){return"SUCCESS"}else{jQuery("#addProvision_errorMsg").text(smartyDataCmdEdit.i18n_errorPleaseCheck+" : "+errMsg);return"ERROR"}}