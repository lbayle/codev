function checkRegexp(e,a,t){return!!a.test(e.val())}function addCmdIssue(){var e=0,a="",t=jQuery.trim(document.forms.addCmdIssueForm.bugid.value);""!=t?new RegExp("^[0-9]+$","i").test(t)||(a+=smartyDataCmdEdit.i18n_nanTaskId+"\n",++e):(a+=smartyDataCmdEdit.i18n_missingFieldTaskId+"\n",++e);0==e?document.forms.addCmdIssueForm.submit():alert(a)}function removeCmdIssue(e,a,t){jQuery("#desc_id").text(e),jQuery("#desc_project").text(a),jQuery("#desc_summary").text(t),jQuery("#formRemoveCmdIssue").find("input[name=bugid]").val(e),jQuery("#removeCmdIssue_dialog_form").dialog("open")}function removeCmdSet(e,a){var t=jQuery("#removeCmdSet_dialog_form");t.find(".desc_id").text(e),t.find(".desc_name").text(a),t.find("#formRemoveCmdSet").find("input[name=commandsetid]").val(e),t.dialog("open")}var provData;function updateADR(){if(""!=jQuery("#budget").val()&&0!=jQuery("#budget").val()&&""!=jQuery("#budgetDays").val()&&0!=jQuery("#budgetDays").val()){var e=parseFloat(jQuery("#budget").val())/parseFloat(jQuery("#budgetDays").val());jQuery("#averageDailyRate").val(e.toFixed(2))}else jQuery("#averageDailyRate").val(0)}function updateBudget(){if(""!=jQuery("#averageDailyRate").val()&&0!=jQuery("#averageDailyRate").val()&&""!=jQuery("#budgetDays").val()&&0!=jQuery("#budgetDays").val()){var e=parseFloat(jQuery("#budgetDays").val())*parseFloat(jQuery("#averageDailyRate").val());jQuery("#budget").val(e.toFixed(2))}}function createProvisionTr(e){var a=jQuery("<tr></tr>").addClass("provRow").attr("data-provRowId",e.provId),t=jQuery('<img align="absmiddle" src="images/b_drop.png">').addClass("deleteProvision_link").addClass("pointer").prop("title",smartyDataCmdEdit.i18n_delete),r=jQuery('<img align="absmiddle" src="images/b_edit.png">').addClass("editProvision_link").addClass("pointer").prop("title",smartyDataCmdEdit.i18n_edit),d=jQuery('<td style="width:38px;">').addClass("ui-state-error-text");d.append(t).append(" ").append(r);var i=jQuery("<span>").text(e.budget).addClass("provBudget"),o=jQuery("<span>").text(e.currency).addClass("provCurrency"),n=jQuery('<td style="text-align: right;">');return n.append(i).append(" ").append(o),a.append(d),a.append(jQuery("<td>").text(e.date).addClass("provDate")),a.append(jQuery("<td>").text(e.type).addClass("provType")),a.append(jQuery("<td>").text(e.budget_days).addClass("provBudgetDays")),a.append(n),a.append(jQuery("<td>").html(e.summary).addClass("provSummary")),e.is_checked?a.append(jQuery("<td>").html('<input type="checkbox" class="cbIsInCheckBudget" disabled="disabled" checked/>')):a.append(jQuery("<td>").html('<input type="checkbox" class="cbIsInCheckBudget" disabled="disabled" />')),e.csvFileLine&&a.attr("data-csvFileLine",e.csvFileLine),a}function addProvisionConsistencyCheck(){jQuery("#addProvision_errorMsg").text("");var e=jQuery("#addProvision_dialog_form"),a="";return""===e.find("#datepicker").val()&&(a+=smartyDataCmdEdit.i18n_date+", "),""===e.find("#budgetDays").val()&&(a+=smartyDataCmdEdit.i18n_budgetDays+", "),""===e.find("#averageDailyRate").val()&&jQuery("#averageDailyRate").val("0"),""===e.find("#budget").val()&&jQuery("#budget").val("0"),""===a?"SUCCESS":(jQuery("#addProvision_errorMsg").text(smartyDataCmdEdit.i18n_errorPleaseCheck+" : "+a),"ERROR")}jQuery(document).ready(function(){var e;"en"!==smartyDataCmdEdit.datepickerLocale&&jQuery.datepicker.setDefaults($.datepicker.regional[smartyDataCmdEdit.datepickerLocale]),""!==smartyDataCmdEdit.cmdStartDate?jQuery("#cmdStartDate").datepicker("setDate",smartyDataCmdEdit.cmdStartDate):jQuery("#cmdStartDate").datepicker(),""!==smartyDataCmdEdit.cmdDeadline?jQuery("#cmdDeadline").datepicker("setDate",smartyDataCmdEdit.cmdDeadline):jQuery("#cmdDeadline").datepicker(),jQuery("#cmdStartDate").datepicker("option","beforeShow",function(e){jQuery(this).datepicker("option","maxDate",jQuery("#cmdDeadline").datepicker("getDate"))}),jQuery("#cmdDeadline").datepicker("option","beforeShow",function(e){jQuery(this).datepicker("option","minDate",jQuery("#cmdStartDate").datepicker("getDate"))}),jQuery("#btSaveCommand").click(function(){var e=0,a="",t=jQuery("#updateCmdInfoForm");if(0==t.find("input[name=cmdName]").val().length&&(a+=smartyDataCmdEdit.i18n_missingFieldCmdName+"\n",++e),""!=t.find("input[name=cmdTotalSoldDays]").val()&&(bValid=checkRegexp(t.find("input[name=cmdTotalSoldDays]"),/^[0-9]+(\.[0-9]+)?$/i,"format: '1234' or '123.35'"),bValid||(a+=smartyDataCmdEdit.i18n_nanSoldCharge+"\n",++e)),0===e)if(""!==smartyDataCmdEdit.cmdId){var r=saveTree();r.done(function(){t.submit()}),r.fail(function(){$("#tree").fancytree("destroy"),initTree()})}else t.submit();else alert(a)}),""!==smartyDataCmdEdit.cmdId&&jQuery("#btDeleteCommand").click(function(e){jQuery("#deleteCommand_dialog_form").dialog("open")}),jQuery("#btAddCmdIssue").click(function(e){addCmdIssue()}),jQuery("#bugid").keypress(function(e){jQuery.ui.keyCode.ENTER==e.keyCode&&(addCmdIssue(),e.preventDefault())}),jQuery.ajax({url:"js_min/datatable.min.js",dataType:"script",cache:!0}),jQuery("#deleteCommand_dialog_form").dialog({autoOpen:!1,resizable:!0,width:"auto",modal:!0,buttons:[{text:smartyDataCmdEdit.i18n_delete,click:function(){jQuery("#formDeleteCommand").submit()}},{text:smartyDataCmdEdit.i18n_cancel,click:function(){jQuery(this).dialog("close")}}]}),jQuery("#removeCmdIssue_dialog_form").dialog({autoOpen:!1,resizable:!0,width:"auto",modal:!0,buttons:[{text:smartyDataCmdEdit.i18n_remove,click:function(){jQuery("#formRemoveCmdIssue").submit()}},{text:smartyDataCmdEdit.i18n_cancel,click:function(){jQuery(this).dialog("close")}}]}),jQuery("#removeCmdSet_dialog_form").dialog({autoOpen:!1,resizable:!0,width:"auto",modal:!0,buttons:[{text:smartyDataCmdEdit.i18n_remove,click:function(){jQuery("#formRemoveCmdSet").submit()}},{text:smartyDataCmdEdit.i18n_cancel,click:function(){jQuery(this).dialog("close")}}]}),jQuery("#provisionsTable").on("click",".deleteProvision_link",function(e){e.preventDefault();var a=$(this).parents(".provRow"),t=$(a).attr("data-provRowId"),r=$(a).children(".provDate").text(),d=$(a).children(".provType").text(),i=$(a).children(".provBudgetDays").text(),o=$(a).find(".provBudget").text(),n=$(a).find(".provCurrency").text(),s=$(a).children(".provSummary").text(),u=smartyDataCmdEdit.i18n_confirmDeleteProvision+"\n\n"+r+" "+d+"\n"+i+" "+smartyDataCmdEdit.i18n_days+"\n"+o+" "+n+"\n\n"+s;confirm(u)&&$.ajax({url:smartyDataCmdEdit.ajaxPage,type:"POST",dataType:"json",data:{action:"deleteProvision",cmdId:smartyDataCmdEdit.cmdId,provRowId:t},success:function(e){null===e?(console.error("ERROR deleteProvision: no data"),alert("ERROR: Please contact your CodevTT administrator")):"SUCCESS"!==e.statusMsg?(console.error("ERROR Ajax statusMsg",e.statusMsg),alert(e.statusMsg)):jQuery(".provRow[data-provRowId='"+e.rowId+"']").remove()},error:function(e,a,t){console.error("ERROR deleteProvision errorThrown",t)}})}),jQuery("#provisionsTable").on("click",".editProvision_link",function(e){var a=$(this).parents(".provRow"),t=$(a).attr("data-provRowId"),r=$(a).children(".provDate").text(),d=$(a).children(".provType").attr("data-provTypeId"),i=$(a).children(".provBudgetDays").text(),o=$(a).find(".provBudget").text(),n=$(a).find(".provCurrency").text(),s=$(a).children(".provSummary").text(),u=$(a).find(".cbIsInCheckBudget").is(":checked");jQuery("#type").val(d),jQuery("#datepicker").val(r),jQuery("#budgetDays").val(i),jQuery("#budget").val(o),jQuery("#provisionCurrency").val(n),jQuery("#provisionCurrencyDisplayed").html(n),jQuery("#summary").val(s),jQuery("#cb_isInCheckBudget").prop("checked",u),jQuery("#addProvRowId").val(t),jQuery("#averageDailyRate").val(""),updateADR();var c=jQuery("#addProvision_dialog_form");c.dialog("option","title",smartyDataCmdEdit.i18n_editProvision),jQuery("#addProvDlgAction").val("editProvision"),c.dialog("open")}),jQuery("#btAddProvision").click(function(e){var a=jQuery("#addProvision_dialog_form");a.dialog("option","title",smartyDataCmdEdit.i18n_addProvision),jQuery("#addProvDlgAction").val("addProvision"),jQuery("#addProvRowId").val(0),jQuery("#datepicker").val(""),jQuery("#budgetDays").val(""),jQuery("#budget").val("0"),jQuery("#summary").val(""),jQuery("#averageDailyRate").val("0"),jQuery("#cb_isInCheckBudget").prop("checked",!1),jQuery("#addProvision_errorMsg").text(""),a.dialog("open")}),jQuery("#addProvision_dialog_form").dialog({autoOpen:!1,resizable:!0,width:"auto",modal:!0,buttons:[{text:"OK",click:function(){var e=jQuery("#cb_isInCheckBudget").attr("checked")?1:0,a=jQuery("#formAddProvision");a.find("input[name=isInCheckBudget]").val(e),"SUCCESS"===addProvisionConsistencyCheck()&&(jQuery.ajax({url:smartyDataCmdEdit.ajaxPage,type:"POST",dataType:"json",async:!1,data:a.serialize(),success:function(e){if("SUCCESS"===e.statusMsg)if(prov=e.provData,"editProvision"===e.action){var a=$(".provRow[data-provRowId="+prov.provId+"]");a.find(".provDate").text(prov.date),a.find(".provType").text(prov.type).attr("data-provTypeId",e.type_id),a.find(".provBudgetDays").text(prov.budget_days),a.find(".provBudget").text(prov.budget),a.find(".provCurrency").text(prov.currency),a.find(".provSummary").html(prov.summary),a.find(".cbIsInCheckBudget").prop("checked",prov.is_checked),a.css("background-color","#ccffcc")}else{var t=createProvisionTr(prov);t.css("background-color","#ffff99"),t.prependTo("#provisionsTable tbody")}else console.error("Ajax statusMsg",e.statusMsg),alert(e.statusMsg)},error:function(e,a,t){"Forbidden"===t?window.location=smartyDataCmdEdit.page:(console.error(a,t),alert("ERROR: Please contact your CodevTT administrator"))}}),jQuery(this).dialog("close"))}},{text:smartyDataCmdEdit.i18n_cancel,click:function(){jQuery(this).dialog("close")}}]}),jQuery("#fileInput").on("change",function(a){e=a.target.files[0]}),jQuery("#btImportProvision").click(function(a){var t=new FormData;t.append("uploaded_csv",e),t.append("action","importProvisionCSV"),t.append("cmdid",smartyDataCmdEdit.cmdId),jQuery.ajax({async:!1,type:"POST",url:smartyDataCmdEdit.ajaxPage,data:t,processData:!1,contentType:!1,dataType:"json",success:function(e){"SUCCESS"===e.statusMsg?(provData=e.provData,jQuery.each(provData,function(e,a){var t=createProvisionTr(a);t.css("background-color","#ffff99"),t.prependTo("#provisionsTable tbody")})):(console.error("Ajax statusMsg",e.statusMsg),alert(e.statusMsg))},error:function(e,a,t){"Forbidden"===t?window.location=smartyDataCmdEdit.page:(console.error(a,t),alert("ERROR: Please contact your CodevTT administrator"))}})}),jQuery("#provisionCurrency").on("change",function(e){var a=jQuery("#provisionCurrency").val();jQuery("#provisionCurrencyDisplayed").html(a)}),jQuery("#budgetDays").keyup(function(e){updateBudget()}),jQuery("#averageDailyRate").keyup(function(e){updateBudget()}),jQuery("#budget").keyup(function(e){updateADR()}),jQuery("#type").change(function(){var e=jQuery("#type").val()!=smartyDataCmdEdit.cmdProvisionTypeMngt;jQuery("#cb_isInCheckBudget").prop("checked",e)})});